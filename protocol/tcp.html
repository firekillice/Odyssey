<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TCP (transmisstion control protocol) | Hungry&amp;Eating</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="">
    <link rel="preload" href="/Odyssey/assets/css/0.styles.35a5e89f.css" as="style"><link rel="preload" href="/Odyssey/assets/js/app.736f8b8a.js" as="script"><link rel="preload" href="/Odyssey/assets/js/2.044c5f79.js" as="script"><link rel="preload" href="/Odyssey/assets/js/10.d41f3c7c.js" as="script"><link rel="prefetch" href="/Odyssey/assets/js/100.69898e8b.js"><link rel="prefetch" href="/Odyssey/assets/js/101.522618eb.js"><link rel="prefetch" href="/Odyssey/assets/js/102.5c58fea2.js"><link rel="prefetch" href="/Odyssey/assets/js/103.231e7290.js"><link rel="prefetch" href="/Odyssey/assets/js/104.014c3e51.js"><link rel="prefetch" href="/Odyssey/assets/js/105.5dec6e62.js"><link rel="prefetch" href="/Odyssey/assets/js/106.4e733698.js"><link rel="prefetch" href="/Odyssey/assets/js/107.60d5b072.js"><link rel="prefetch" href="/Odyssey/assets/js/108.9e6ad3f3.js"><link rel="prefetch" href="/Odyssey/assets/js/109.6baf415c.js"><link rel="prefetch" href="/Odyssey/assets/js/11.f2fee731.js"><link rel="prefetch" href="/Odyssey/assets/js/110.8fd1b2b3.js"><link rel="prefetch" href="/Odyssey/assets/js/111.4c25b1c5.js"><link rel="prefetch" href="/Odyssey/assets/js/112.ad336252.js"><link rel="prefetch" href="/Odyssey/assets/js/12.8a1ba8cb.js"><link rel="prefetch" href="/Odyssey/assets/js/13.2b7a02b1.js"><link rel="prefetch" href="/Odyssey/assets/js/14.dd904d52.js"><link rel="prefetch" href="/Odyssey/assets/js/15.34ceb40c.js"><link rel="prefetch" href="/Odyssey/assets/js/16.f321f7c9.js"><link rel="prefetch" href="/Odyssey/assets/js/17.affaebd6.js"><link rel="prefetch" href="/Odyssey/assets/js/18.5503f8b8.js"><link rel="prefetch" href="/Odyssey/assets/js/19.ed696375.js"><link rel="prefetch" href="/Odyssey/assets/js/20.be5f35fa.js"><link rel="prefetch" href="/Odyssey/assets/js/21.a5102283.js"><link rel="prefetch" href="/Odyssey/assets/js/22.82e0c238.js"><link rel="prefetch" href="/Odyssey/assets/js/23.2b17eea6.js"><link rel="prefetch" href="/Odyssey/assets/js/24.4508b587.js"><link rel="prefetch" href="/Odyssey/assets/js/25.86c8fb1f.js"><link rel="prefetch" href="/Odyssey/assets/js/26.105a4513.js"><link rel="prefetch" href="/Odyssey/assets/js/27.dc65fe01.js"><link rel="prefetch" href="/Odyssey/assets/js/28.7ee124c8.js"><link rel="prefetch" href="/Odyssey/assets/js/29.50d7e58a.js"><link rel="prefetch" href="/Odyssey/assets/js/3.76432ce0.js"><link rel="prefetch" href="/Odyssey/assets/js/30.002de48f.js"><link rel="prefetch" href="/Odyssey/assets/js/31.eb86b12f.js"><link rel="prefetch" href="/Odyssey/assets/js/32.2d83f202.js"><link rel="prefetch" href="/Odyssey/assets/js/33.879c8d31.js"><link rel="prefetch" href="/Odyssey/assets/js/34.1891a7db.js"><link rel="prefetch" href="/Odyssey/assets/js/35.2425bacc.js"><link rel="prefetch" href="/Odyssey/assets/js/36.51acb1aa.js"><link rel="prefetch" href="/Odyssey/assets/js/37.37bff99e.js"><link rel="prefetch" href="/Odyssey/assets/js/38.3f8720f7.js"><link rel="prefetch" href="/Odyssey/assets/js/39.76e0dc46.js"><link rel="prefetch" href="/Odyssey/assets/js/4.ad59de73.js"><link rel="prefetch" href="/Odyssey/assets/js/40.7ec36cd5.js"><link rel="prefetch" href="/Odyssey/assets/js/41.069851a8.js"><link rel="prefetch" href="/Odyssey/assets/js/42.7c97bffd.js"><link rel="prefetch" href="/Odyssey/assets/js/43.f04444ab.js"><link rel="prefetch" href="/Odyssey/assets/js/44.e4ed2b3f.js"><link rel="prefetch" href="/Odyssey/assets/js/45.6a2e2f62.js"><link rel="prefetch" href="/Odyssey/assets/js/46.80a2cf59.js"><link rel="prefetch" href="/Odyssey/assets/js/47.06744c06.js"><link rel="prefetch" href="/Odyssey/assets/js/48.7e16dc16.js"><link rel="prefetch" href="/Odyssey/assets/js/49.e88ae0cf.js"><link rel="prefetch" href="/Odyssey/assets/js/5.3986ff40.js"><link rel="prefetch" href="/Odyssey/assets/js/50.8f65c57c.js"><link rel="prefetch" href="/Odyssey/assets/js/51.8bb5804d.js"><link rel="prefetch" href="/Odyssey/assets/js/52.110679f9.js"><link rel="prefetch" href="/Odyssey/assets/js/53.ed3457ae.js"><link rel="prefetch" href="/Odyssey/assets/js/54.eff49780.js"><link rel="prefetch" href="/Odyssey/assets/js/55.77bfb65f.js"><link rel="prefetch" href="/Odyssey/assets/js/56.f9d2ff1e.js"><link rel="prefetch" href="/Odyssey/assets/js/57.9463926d.js"><link rel="prefetch" href="/Odyssey/assets/js/58.73a73232.js"><link rel="prefetch" href="/Odyssey/assets/js/59.3a3e853e.js"><link rel="prefetch" href="/Odyssey/assets/js/6.348464c7.js"><link rel="prefetch" href="/Odyssey/assets/js/60.9c66dd2d.js"><link rel="prefetch" href="/Odyssey/assets/js/61.ee0b9a8b.js"><link rel="prefetch" href="/Odyssey/assets/js/62.76d18fcb.js"><link rel="prefetch" href="/Odyssey/assets/js/63.dd25e434.js"><link rel="prefetch" href="/Odyssey/assets/js/64.f2cd0b44.js"><link rel="prefetch" href="/Odyssey/assets/js/65.47204a7c.js"><link rel="prefetch" href="/Odyssey/assets/js/66.605a4a82.js"><link rel="prefetch" href="/Odyssey/assets/js/67.34132ce0.js"><link rel="prefetch" href="/Odyssey/assets/js/68.f3bcfc00.js"><link rel="prefetch" href="/Odyssey/assets/js/69.3640c28b.js"><link rel="prefetch" href="/Odyssey/assets/js/7.869b5935.js"><link rel="prefetch" href="/Odyssey/assets/js/70.e2a8446b.js"><link rel="prefetch" href="/Odyssey/assets/js/71.c9f6b4d3.js"><link rel="prefetch" href="/Odyssey/assets/js/72.201bfcc2.js"><link rel="prefetch" href="/Odyssey/assets/js/73.7e8e995e.js"><link rel="prefetch" href="/Odyssey/assets/js/74.ea2a2167.js"><link rel="prefetch" href="/Odyssey/assets/js/75.7009c10e.js"><link rel="prefetch" href="/Odyssey/assets/js/76.48b75434.js"><link rel="prefetch" href="/Odyssey/assets/js/77.fa8e9cd3.js"><link rel="prefetch" href="/Odyssey/assets/js/78.5cb5a672.js"><link rel="prefetch" href="/Odyssey/assets/js/79.5adebe29.js"><link rel="prefetch" href="/Odyssey/assets/js/8.a0861537.js"><link rel="prefetch" href="/Odyssey/assets/js/80.fcb9624a.js"><link rel="prefetch" href="/Odyssey/assets/js/81.42c49b3a.js"><link rel="prefetch" href="/Odyssey/assets/js/82.477309e7.js"><link rel="prefetch" href="/Odyssey/assets/js/83.38767490.js"><link rel="prefetch" href="/Odyssey/assets/js/84.c80b8f93.js"><link rel="prefetch" href="/Odyssey/assets/js/85.b1ca1383.js"><link rel="prefetch" href="/Odyssey/assets/js/86.0bb83cf2.js"><link rel="prefetch" href="/Odyssey/assets/js/87.632e928e.js"><link rel="prefetch" href="/Odyssey/assets/js/88.924c9285.js"><link rel="prefetch" href="/Odyssey/assets/js/89.34d3c3ff.js"><link rel="prefetch" href="/Odyssey/assets/js/9.14a4b067.js"><link rel="prefetch" href="/Odyssey/assets/js/90.2e394c85.js"><link rel="prefetch" href="/Odyssey/assets/js/91.b604e092.js"><link rel="prefetch" href="/Odyssey/assets/js/92.94b169d8.js"><link rel="prefetch" href="/Odyssey/assets/js/93.0e2742ef.js"><link rel="prefetch" href="/Odyssey/assets/js/94.449bcab7.js"><link rel="prefetch" href="/Odyssey/assets/js/95.250c02be.js"><link rel="prefetch" href="/Odyssey/assets/js/96.eee6aed4.js"><link rel="prefetch" href="/Odyssey/assets/js/97.3198ad58.js"><link rel="prefetch" href="/Odyssey/assets/js/98.1b0a34c9.js"><link rel="prefetch" href="/Odyssey/assets/js/99.9021c172.js">
    <link rel="stylesheet" href="/Odyssey/assets/css/0.styles.35a5e89f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Odyssey/" class="home-link router-link-active"><!----> <span class="site-name">Hungry&amp;Eating</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Odyssey/reading/" class="nav-link">
  阅读
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机综合" class="dropdown-title"><span class="title">学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机综合" class="mobile-dropdown-title"><span class="title">学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Odyssey/cache/" class="nav-link">
  缓存
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/code/" class="nav-link">
  coding
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/struct/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/db/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/storage/" class="nav-link">
  存储
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/protocol/" class="nav-link router-link-active">
  协议
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/network/" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/design/" class="nav-link">
  设计
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/web/" class="nav-link">
  www
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/insight/" class="nav-link">
  理解
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/unclassified/" class="nav-link">
  未分类
</a></li></ul></div></div> <a href="https://github.com/firekillice/Odyssey" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Odyssey/reading/" class="nav-link">
  阅读
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机综合" class="dropdown-title"><span class="title">学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机综合" class="mobile-dropdown-title"><span class="title">学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Odyssey/cache/" class="nav-link">
  缓存
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/code/" class="nav-link">
  coding
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/struct/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/db/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/storage/" class="nav-link">
  存储
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/protocol/" class="nav-link router-link-active">
  协议
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/network/" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/design/" class="nav-link">
  设计
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/web/" class="nav-link">
  www
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/insight/" class="nav-link">
  理解
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/unclassified/" class="nav-link">
  未分类
</a></li></ul></div></div> <a href="https://github.com/firekillice/Odyssey" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>协议</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Odyssey/protocol/" aria-current="page" class="sidebar-link">协议</a></li><li><a href="/Odyssey/protocol/http.html" class="sidebar-link">HTTP</a></li><li><a href="/Odyssey/protocol/tcp.html" aria-current="page" class="active sidebar-link">TCP (transmisstion control protocol)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#arq" class="sidebar-link">ARQ</a></li><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#mss-max-segment-size" class="sidebar-link">MSS（Max Segment Size）</a></li><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#糊涂窗口综合症-silly-window-syndrome" class="sidebar-link">糊涂窗口综合症(Silly Window Syndrome)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#nagle算法" class="sidebar-link">Nagle算法</a></li></ul></li><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#超时计算" class="sidebar-link">超时计算</a></li><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#拥塞控制-congestion-control" class="sidebar-link">拥塞控制(Congestion Control)</a></li><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#tfo" class="sidebar-link">TFO</a></li><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#流量控制-flow-control" class="sidebar-link">流量控制(Flow Control)</a></li><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#slide-window-protocol" class="sidebar-link">slide window protocol</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#重传机制" class="sidebar-link">重传机制</a></li><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#确认机制" class="sidebar-link">确认机制</a></li></ul></li><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#keep-alive" class="sidebar-link">keep alive</a></li><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#_3-way-handshake" class="sidebar-link">3-way handshake</a></li><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#sequence-number" class="sidebar-link">sequence number</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#initial-sequence-number-isn" class="sidebar-link">Initial sequence number(ISN)</a></li><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#sequence-number-synchronization" class="sidebar-link">sequence number synchronization</a></li></ul></li><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#interface" class="sidebar-link">interface</a></li><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#attack-based-on-tcp" class="sidebar-link">attack based on tcp</a></li><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#参数" class="sidebar-link">参数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Odyssey/protocol/tcp.html#keep-alive-2" class="sidebar-link">keep-alive</a></li></ul></li></ul></li><li><a href="/Odyssey/protocol/ip.html" class="sidebar-link">Internet Protocol</a></li><li><a href="/Odyssey/protocol/tls.html" class="sidebar-link">ssl</a></li><li><a href="/Odyssey/protocol/kcp.html" class="sidebar-link">KCP</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tcp-transmisstion-control-protocol"><a href="#tcp-transmisstion-control-protocol" class="header-anchor">#</a> TCP (transmisstion control protocol)</h1> <ul><li>TCP provides reliable and sequenced delivery of messages in each direction.</li> <li>就是说，tcp的事情是要在不可靠的网络环境上建立可靠的信息传输；有点像分布式理论，需要在不可靠的硬件环境下建立可靠的服务</li> <li>将通信的概念分解为信息传输，将信息传输的概念分解为信息的输出与接收；那么比如广告也是一种信息输出与接收，就没有三次握手，也是有效的。关键还是在于基础环境的不稳定才需要这样做。所以本质上讲，tcp层的协议主要是tcp、udp，提供一种可靠的和一种不太可靠的，这样就能满足基本的需求了。</li> <li><img src="/Odyssey/assets/img/tcp-header2.1a484788.png" alt="image">, 至于option部分，比如SACK是一个TCP的选项，之所以有head-length字段，就是因为选项部分是可变长的，否则直接固定20 byte就行了</li> <li>从tcp的包头来看，tcp复杂的协议流程主要是基于SEQ和WIN的</li> <li>TCP必需要解决的可靠传输以及包乱序（reordering）的问题</li> <li><strong>connection-oriented</strong></li> <li>two streams、two sequence number in both endpoint、bidirectional</li> <li>A connection is defined by a 5-tuple: protocol, local-addr, local-port, remote-addr, remote-port.</li> <li>流水线机制，提高传输的效率</li> <li>全双工(full-duplex)传输</li></ul> <h2 id="arq"><a href="#arq" class="header-anchor">#</a> ARQ</h2> <ul><li>stop-and-wait停止等待协议是最简单但也是最基础的数据链路层协议</li> <li>Automatic Repeat Request, ARQ is generic name for protocols based on this strategy</li> <li>is an error-control method for data transmission that uses acknowledgements (messages sent by the receiver indicating that it has correctly received a packet) and timeouts (specified periods of time allowed to elapse before an acknowledgment is to be received) to achieve reliable data transmission over an unreliable communication channel.</li> <li>Go-Back-N ARQ，就是一直确认最小的序列号</li> <li>滑动窗口就是pipeline化的ARQ</li></ul> <h2 id="mss-max-segment-size"><a href="#mss-max-segment-size" class="header-anchor">#</a> MSS（Max Segment Size）</h2> <ul><li>TCP的RFC定义这个MSS的默认值是536, 这是因为 RFC 791里说了任何一个IP设备都得最少接收576尺寸的大小</li></ul> <h2 id="糊涂窗口综合症-silly-window-syndrome"><a href="#糊涂窗口综合症-silly-window-syndrome" class="header-anchor">#</a> 糊涂窗口综合症(Silly Window Syndrome)</h2> <ul><li><p>如果我们的接收方太忙了，来不及取走Receive Windows里的数据，那么，就会导致发送方越来越小。到最后，如果接收方腾出几个字节并告诉发送方现在有几个字节的window，而我们的发送方会义无反顾地发送这几个字节。(On the receiving system, TCP stores received data in a receive buffer. TCP acknowledges receipt of the data, and advertises (communicates) a new receive window to the sending system. The receive window represents the number of bytes that are available in the receive buffer. ) <strong>所以接收侧滑动窗口管理的buffer和应用读取数据的buffer是同一个(receive buffer)，所以接收方的接收窗口是包括上层未取走的数据的长度;发送侧的滑动窗口管理的buffer和写数据用的也是同一个缓存(send buffer);receive-buffer和send-buff是read、write接口，也就是程序能感受到的与滑动窗口的关系</strong>.</p></li> <li><p><img src="/Odyssey/assets/img/20200921221636.5fa41b89.png" alt="image"></p></li> <li><p>在receiver端，如果收到的数据导致window size小于某个值，可以直接ack(0)回sender，这样就把window给关闭了，也阻止了sender再发数据过来，等到receiver端处理了一些数据后windows size 大于等于了MSS，或者，receiver buffer有一半为空，就可以把window打开让send 发送数据过来。</p></li> <li><p>如果这个问题是由Sender端引起的，那么就会使用著名的 Nagle’s algorithm。这个算法的思路也是延时处理，他有两个主要的条件：1）要等到 Window Size&gt;=MSS 或是 Data Size &gt;=MSS，2）收到之前发送数据的ack回包，他才会发数据，否则就是在攒数据。</p></li> <li><p>如果不处理这两种情况，相当于用巴士每次运送一个乘客</p></li></ul> <h3 id="nagle算法"><a href="#nagle算法" class="header-anchor">#</a> Nagle算法</h3> <ul><li>默认是开启状态，也就是TCP_NODELAY是关闭状态的</li></ul> <h2 id="超时计算"><a href="#超时计算" class="header-anchor">#</a> 超时计算</h2> <ul><li>RTT(Round Trip Time)</li> <li>RTO（Retransmission TimeOut），作为数据包超时的计算标准</li> <li>不能针对所有的情况设置固定的超时值，需要动态优化, 利用RTT计算RTO</li> <li>不同的连接，通过循环的采样和计算来不断的更新当前的超时时间</li> <li>这个是一种状态机的不断切换的过程，将最新的数据不断的迭代进去，得到更新后的值</li> <li>RTO抖一抖，可能导致很多包的重发</li> <li>每个segment都有一个定时器</li> <li>现行算法</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>其中的DevRTT是Deviation RTT的意思

SRTT = SRTT + α (RTT – SRTT)  —— 计算平滑RTT

DevRTT = (1-β)*DevRTT + β*(|RTT-SRTT|) ——计算平滑RTT和真实的差距（加权移动平均）

RTO= µ * SRTT + ∂ *DevRTT —— 神一样的公式

（其中：在Linux下，α = 0.125，β = 0.25， μ = 1，∂ = 4 ——这就是算法中的“调得一手好参
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="拥塞控制-congestion-control"><a href="#拥塞控制-congestion-control" class="header-anchor">#</a> 拥塞控制(Congestion Control)</h2> <ul><li>Algorithms to prevent that the sender overloads the network</li> <li>TCP的设计者觉得，一个伟大而牛逼的协议仅仅做到流控并不够，因为流控只是网络模型4层以上的事，TCP的还应该更聪明地知道整个网络上的事。</li> <li>TCP不能忽略网络上发生的事情，而无脑地一个劲地重发数据，对网络造成更大的伤害。对此TCP的设计理念是：TCP不是一个自私的协议，当拥塞发生的时候，要做自我牺牲。就像交通阻塞一样，每个车都应该把路让出来，而不要再去抢路了。(只要人人都献出一点爱)</li> <li>流量控制做的总量的控制，而拥塞控制做的则是加速度的控制</li> <li>1）慢启动，2）拥塞避免，3）拥塞发生，4）快速恢复。</li> <li><img src="/Odyssey/assets/img/tcp.fr_-900x315.7cd635e6.jpg" alt="image"></li></ul> <h2 id="tfo"><a href="#tfo" class="header-anchor">#</a> TFO</h2> <ul><li>2014 年提出的 TCP 快启（TCP Fast Open，TFO）却可以在某些场景下通过一次通信建立 TCP 连接8。</li> <li>TFO是GOOGLE发布的。目前chrome已经支持TFO，但默认是关闭的，因为它有一些特定的使用场景。
<img src="/Odyssey/assets/img/20200201180517.18387b52.png" alt="tfo vs regular"></li></ul> <h2 id="流量控制-flow-control"><a href="#流量控制-flow-control" class="header-anchor">#</a> 流量控制(Flow Control)</h2> <ul><li>Algorithms to prevent that the sender overruns the receiver with information</li> <li>tcp的整个流量控制的模型就是滑动窗口，所有的算法都是围绕该机制设计的</li></ul> <h2 id="slide-window-protocol"><a href="#slide-window-protocol" class="header-anchor">#</a> slide window protocol</h2> <ul><li>Sliding window protocols are data link layer protocols for reliable and sequential delivery of data frames.</li> <li>In these protocols, the sender has a buffer called the sending window and the receiver has buffer called the receiving window.</li> <li><img src="/Odyssey/assets/img/20200921115940.fc3c6ca7.png" alt="滑动窗口"></li> <li><img src="/Odyssey/assets/img/Sliding-Window-Protocol.dd91c759.jpg" alt="滑动窗口"></li> <li>The term sliding window refers to the imaginary boxes to hold frames. 或者： 在序列号形成的轨道上，有一辆小火车在慢慢的走；或者说像一个蒙版在一个长方形的图片上滑动；其实就是像窗口一样，可以调节大小并且可以移动.</li> <li><img src="/Odyssey/assets/img/slide_8.cb5c9f8f.jpg" alt="滑动窗口的数据组成">，即当有数据被ack的时候，窗口会向右滑动，产生新的可以被send的数据</li> <li><img src="/Odyssey/assets/img/20200921120446.6b816c89.png" alt="win-size"></li> <li><img src="/Odyssey/assets/img/sending.70bd50a3.jpg" alt="two-type-window">，两个窗口就像两个大小相同的海绵宝宝，可以大小调节，但是最大个头一样</li> <li>重传机制是基于确认机制的</li></ul> <h3 id="重传机制"><a href="#重传机制" class="header-anchor">#</a> 重传机制</h3> <h4 id="快速重传-fast-retransmit"><a href="#快速重传-fast-retransmit" class="header-anchor">#</a> 快速重传(Fast Retransmit )</h4> <ul><li><img src="/Odyssey/assets/img/FASTIncast021.b1adce98.png" alt="来自陈皓博客的图片"></li> <li>主要是为了优化timeout逻辑</li></ul> <h3 id="确认机制"><a href="#确认机制" class="header-anchor">#</a> 确认机制</h3> <h4 id="cumulative-acknowledgement-累计确认-延迟确认"><a href="#cumulative-acknowledgement-累计确认-延迟确认" class="header-anchor">#</a> Cumulative acknowledgement(累计确认，延迟确认)</h4> <ul><li>A process in which the receiver sends a single acknowledgement in response to a finite number of frames received.  It reduces the time and bandwidth wasted for sending
acknowledgement.</li> <li>所以ACK确认序列号是勇往直前的，不能回头的</li></ul> <h4 id="选择确认-selective-acknowledgment-sack"><a href="#选择确认-selective-acknowledgment-sack" class="header-anchor">#</a> 选择确认(Selective Acknowledgment, SACK)</h4> <ul><li>为了减少不必要的数据传输而引入的</li> <li>这个是tcp协议的扩展功能，是对快速重传和累计确认的优化，在 Linux下，可以通过tcp_sack参数打开这个功能（Linux 2.4后默认打开）。</li> <li><img src="/Odyssey/assets/img/tcp_sack_example-900x507.73e82f5f.jpg" alt="image"></li> <li>Duplicate SACK, D-SACK, 其主要使用了SACK来告诉发送方有哪些数据被重复接收了。</li> <li>Reneging: 接收方有权把已经报给发送端SACK里的数据给丢了。所以，发送方也不能完全依赖SACK，还是要依赖ACK，并维护Time-Out，如果后续的ACK没有增长，那么还是要把SACK的东西重传，另外，接收端这边永远不能把SACK的包标记为Ack。</li></ul> <h2 id="keep-alive"><a href="#keep-alive" class="header-anchor">#</a> keep alive</h2> <ul><li>防止大量无用连接的方法</li> <li>中间设备如防火墙等，会为经过它的数据报文建立相关的连接信息表，并未其设置一个超时时间的定时器，如果超出预定时间，某连接无任何报文交互的话，中间设备会将该连接信息从表中删除，在删除后，再有应用报文过来时，中间设备将丢弃该报文</li> <li>完成对空闲连接的审计</li> <li>KeepAlive prevents valid idle connections from being disconnected by firewalls and proxies by maintaining network activity.</li> <li>If either the client or server does not respond to a packet, the connection is considered inactive and is terminated. I</li> <li>RFC: Implementors <strong>MAY include</strong>(RFC并没有规定系统协议栈一定必须实现keepalive) &quot;keep-alives&quot; in their TCPimplementations, although this practice is not universally accepted.  If keep-alives are included, the application MUST be able to turn them on or off for each TCP connection, and <strong>they MUST default to off</strong>.</li> <li>实现机制： SEG.SEQ = SND.NXT-1，即TCP保活探测报文序列号将前一个TCP报文序列号减1。SND.NXT = RCV.NXT，即下一次发送正常报文序号等于ACK序列号；总之保活报文不在窗口控制范围内 <img src="/Odyssey/assets/img/1574164232916-b6ae54d6-d2b3-48e7-b116-60735fef7404.38d72e61.png" alt="image"></li></ul> <h2 id="_3-way-handshake"><a href="#_3-way-handshake" class="header-anchor">#</a> 3-way handshake</h2> <ul><li>The protocol is connection-oriented, means before sending any data to the remote peer, TCP client set up a <strong>virtual connection</strong> over a <strong>packet-based underlying IP network</strong>.</li> <li>3次握手以后，我对这条信道的“信心”就建立起来了：起码就目前而言，这条信道是畅通的。当然更多次的握手，会让我对这条信道可靠性的信心越来越强，但3次是建立信心的最低次数。永远都不能完美的达成协议&amp;世界上不存在完全可靠的通信协议。从通信时间成本空间成本以及可靠度来讲，选择了“三次握手”作为点对点通信的一般规则。</li> <li>确认几个信息: 双方活跃、窗口、序号</li> <li>SYN包其实传递是一个向量，开始值为ISN，长度为WIN的长度</li> <li>If the handshake is successful, the TCP user gets the connection identifier. Else and error.  Connection identifier works as a handler for sending/receiving data to/from the server.</li></ul> <h2 id="sequence-number"><a href="#sequence-number" class="header-anchor">#</a> sequence number</h2> <ul><li>TCP needs an identifier for each byte. The TCP sequence number is a four bytes identifier, to identify each byte in a TCP stream.</li> <li>A TCP sequence number is a four bytes value or 32 bits value. Value can be from 0 to 2^32 – 1 (4,294,967,295).   After reaching the largest value, TCP will continue with the value zero.</li> <li>TCP window maximum size is 2^16 – 1. Means if sequence number has reached the limit of 2^32 – 1, means, sequence numbers from 0 to 2^16, has been already acknowledged.</li> <li>SEQ是一个循环使用的32-bit整数</li> <li>Transmit Sequence Number (TSN) is the SN of the next byte to be transmitted.</li> <li>Ack’d Sequence Number (ASN) is the SN of the next byte that the receiver is expecting.</li> <li>不同连接之间的序列号没有任何关系</li> <li>序列号指的是segment中第一个字节的编号</li></ul> <h3 id="initial-sequence-number-isn"><a href="#initial-sequence-number-isn" class="header-anchor">#</a> Initial sequence number(ISN)</h3> <ul><li>TCP ideally sets initial values in a random and unpredictable way. Using pseudo-random values at session initiation helps frustrate replay attacks on the network.</li> <li>不同的 OS 在选择生成 TCP ISN 时采用不同的方法</li> <li>Traditionally, each device chose the ISN by making use of a timed counter, like a clock of sorts,
that was incremented every 4 microseconds.
This counter was initialized when TCP started up and then its value increased by 1 every 4 microseconds
until it reached the largest 32-bit value possible (4,294,967,295) at which point it “wrapped around” to 0
and resumed incrementing.</li> <li>RFC1948定义的这个算法：ISN = M + F (Sip, Sport, Dip, Dport, <Some Secret="">)，M：单调增加的计数器， F：单向散列哈希函数 (例如 MD4 or MD5)</Some></li></ul> <h3 id="sequence-number-synchronization"><a href="#sequence-number-synchronization" class="header-anchor">#</a> sequence number synchronization</h3> <ul><li>As part of the process of connection establishment, each of the two devices in a TCP connection informs the other of the sequence number it plans to use for its first data transmission by putting the preceding sequence number in the Sequence Number field of its SYN message. The other device confirms this by incrementing that value and putting it into the Acknowledgment Number field of its ACK, telling the other device that is the sequence number it is expecting for the first data transmission. This process is called sequence number synchronization.</li> <li>SYN包为什么是SYN包，就是要SYN序列号. 三次握手虽然没有传输数据，但是SEQ仍然加一，在后面的传输中，如果没有数据，则不会+1。+1的话，ack的逻辑和滑动窗口的逻辑都可以通用，SYN包、数据包、FIN包一样，他们都是需要和可以ACK的数据（因为都携带了信息），所以SEQ需要累加。因为从协议上看，ACK flag被启用就体现在序列号字段上，否则ACK数据和ACK SYN包是没有区别的。就是SYN包必须ACK，而ACK必须使用滑动窗口机制。</li> <li>SYN是建立连接的关键字段，而为了确保对方接收到，使用超时重传机制，TCP规定，只为有数据的TCP报文重传，SYN占据一个序号（可以认为只有一个字节数据的报文），所以TCP会重传SYN报文。</li></ul> <h2 id="interface"><a href="#interface" class="header-anchor">#</a> interface</h2> <ul><li>accept: The accept() function shall extract the first connection on the queue of pending connections, create a new socket with the same socket type protocol and address family as the specified socket, and allocate a new file descriptor for that socket.</li> <li>PRODURE: <img src="/Odyssey/assets/img/TCP-connection.30aa1c2b.png" alt="image"></li> <li>The call accepts the first connection on its queue of pending connections for the given socket socket. The accept() call creates a new socket descriptor with the same properties as socket and returns it to the caller. （accept的参数socket是用于等待连接的socket，而返回的socket则是用来通信的socket，所以并不是所有的socket都是基于四元组的，或者linux的socket是一种抽象,socket的概念是用户层的概念）</li></ul> <h2 id="attack-based-on-tcp"><a href="#attack-based-on-tcp" class="header-anchor">#</a> attack based on tcp</h2> <ul><li>情景一：C处于A与B之间流量的路径上C可以捕获到A、B的IP包，伪造是小菜一碟，比如大防火墙reset用户连接</li> <li>情景二：C不在A与B之间流量的路径上C可以在世界的任何角落，伪造一个合法TCP报文，最关键是TCP字段里的sequence number 、acknowledged number，只要这两项位于接收者滑动窗口内，就是合法的，对方可以接收并Reset A、B之间的TCP连接。</li> <li>replay attack: 回放攻击, 这可以由发起者或由拦截数据并重新传输数据的对手来执行，这可能是通过IP数据包替换进行的欺骗攻击的一部分。Man-in-the-middle attack，缩写：MITM, 中间人攻击的一种形式</li> <li>dos vs ddos   拒绝服务和分布式拒绝服务</li> <li>tcp 会话劫持</li> <li>ip 欺骗，因为没有可靠的身份认证</li></ul> <h2 id="参数"><a href="#参数" class="header-anchor">#</a> 参数</h2> <h3 id="keep-alive-2"><a href="#keep-alive-2" class="header-anchor">#</a> keep-alive</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>net.ipv4.tcp_keepalive_intvl = 75

net.ipv4.tcp_keepalive_probes = 9

net.ipv4.tcp_keepalive_time = 7200
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/firekillice/Odyssey/edit/master/docs/protocol/tcp.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: :</span> <span class="time">10/16/2020, 10:23:12 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Odyssey/protocol/http.html" class="prev">
        HTTP
      </a></span> <span class="next"><a href="/Odyssey/protocol/ip.html">
        Internet Protocol
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Odyssey/assets/js/app.736f8b8a.js" defer></script><script src="/Odyssey/assets/js/2.044c5f79.js" defer></script><script src="/Odyssey/assets/js/10.d41f3c7c.js" defer></script>
  </body>
</html>
