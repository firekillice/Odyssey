<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>mongo代码阅读 | Hungry&amp;Eating</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="">
    <link rel="preload" href="/Odyssey/assets/css/0.styles.35a5e89f.css" as="style"><link rel="preload" href="/Odyssey/assets/js/app.736f8b8a.js" as="script"><link rel="preload" href="/Odyssey/assets/js/2.044c5f79.js" as="script"><link rel="preload" href="/Odyssey/assets/js/17.affaebd6.js" as="script"><link rel="prefetch" href="/Odyssey/assets/js/10.d41f3c7c.js"><link rel="prefetch" href="/Odyssey/assets/js/100.69898e8b.js"><link rel="prefetch" href="/Odyssey/assets/js/101.522618eb.js"><link rel="prefetch" href="/Odyssey/assets/js/102.5c58fea2.js"><link rel="prefetch" href="/Odyssey/assets/js/103.231e7290.js"><link rel="prefetch" href="/Odyssey/assets/js/104.014c3e51.js"><link rel="prefetch" href="/Odyssey/assets/js/105.5dec6e62.js"><link rel="prefetch" href="/Odyssey/assets/js/106.4e733698.js"><link rel="prefetch" href="/Odyssey/assets/js/107.60d5b072.js"><link rel="prefetch" href="/Odyssey/assets/js/108.9e6ad3f3.js"><link rel="prefetch" href="/Odyssey/assets/js/109.6baf415c.js"><link rel="prefetch" href="/Odyssey/assets/js/11.f2fee731.js"><link rel="prefetch" href="/Odyssey/assets/js/110.8fd1b2b3.js"><link rel="prefetch" href="/Odyssey/assets/js/111.4c25b1c5.js"><link rel="prefetch" href="/Odyssey/assets/js/112.ad336252.js"><link rel="prefetch" href="/Odyssey/assets/js/12.8a1ba8cb.js"><link rel="prefetch" href="/Odyssey/assets/js/13.2b7a02b1.js"><link rel="prefetch" href="/Odyssey/assets/js/14.dd904d52.js"><link rel="prefetch" href="/Odyssey/assets/js/15.34ceb40c.js"><link rel="prefetch" href="/Odyssey/assets/js/16.f321f7c9.js"><link rel="prefetch" href="/Odyssey/assets/js/18.5503f8b8.js"><link rel="prefetch" href="/Odyssey/assets/js/19.ed696375.js"><link rel="prefetch" href="/Odyssey/assets/js/20.be5f35fa.js"><link rel="prefetch" href="/Odyssey/assets/js/21.a5102283.js"><link rel="prefetch" href="/Odyssey/assets/js/22.82e0c238.js"><link rel="prefetch" href="/Odyssey/assets/js/23.2b17eea6.js"><link rel="prefetch" href="/Odyssey/assets/js/24.4508b587.js"><link rel="prefetch" href="/Odyssey/assets/js/25.86c8fb1f.js"><link rel="prefetch" href="/Odyssey/assets/js/26.105a4513.js"><link rel="prefetch" href="/Odyssey/assets/js/27.dc65fe01.js"><link rel="prefetch" href="/Odyssey/assets/js/28.7ee124c8.js"><link rel="prefetch" href="/Odyssey/assets/js/29.50d7e58a.js"><link rel="prefetch" href="/Odyssey/assets/js/3.76432ce0.js"><link rel="prefetch" href="/Odyssey/assets/js/30.002de48f.js"><link rel="prefetch" href="/Odyssey/assets/js/31.eb86b12f.js"><link rel="prefetch" href="/Odyssey/assets/js/32.2d83f202.js"><link rel="prefetch" href="/Odyssey/assets/js/33.879c8d31.js"><link rel="prefetch" href="/Odyssey/assets/js/34.1891a7db.js"><link rel="prefetch" href="/Odyssey/assets/js/35.2425bacc.js"><link rel="prefetch" href="/Odyssey/assets/js/36.51acb1aa.js"><link rel="prefetch" href="/Odyssey/assets/js/37.37bff99e.js"><link rel="prefetch" href="/Odyssey/assets/js/38.3f8720f7.js"><link rel="prefetch" href="/Odyssey/assets/js/39.76e0dc46.js"><link rel="prefetch" href="/Odyssey/assets/js/4.ad59de73.js"><link rel="prefetch" href="/Odyssey/assets/js/40.7ec36cd5.js"><link rel="prefetch" href="/Odyssey/assets/js/41.069851a8.js"><link rel="prefetch" href="/Odyssey/assets/js/42.7c97bffd.js"><link rel="prefetch" href="/Odyssey/assets/js/43.f04444ab.js"><link rel="prefetch" href="/Odyssey/assets/js/44.e4ed2b3f.js"><link rel="prefetch" href="/Odyssey/assets/js/45.6a2e2f62.js"><link rel="prefetch" href="/Odyssey/assets/js/46.80a2cf59.js"><link rel="prefetch" href="/Odyssey/assets/js/47.06744c06.js"><link rel="prefetch" href="/Odyssey/assets/js/48.7e16dc16.js"><link rel="prefetch" href="/Odyssey/assets/js/49.e88ae0cf.js"><link rel="prefetch" href="/Odyssey/assets/js/5.3986ff40.js"><link rel="prefetch" href="/Odyssey/assets/js/50.8f65c57c.js"><link rel="prefetch" href="/Odyssey/assets/js/51.8bb5804d.js"><link rel="prefetch" href="/Odyssey/assets/js/52.110679f9.js"><link rel="prefetch" href="/Odyssey/assets/js/53.ed3457ae.js"><link rel="prefetch" href="/Odyssey/assets/js/54.eff49780.js"><link rel="prefetch" href="/Odyssey/assets/js/55.77bfb65f.js"><link rel="prefetch" href="/Odyssey/assets/js/56.f9d2ff1e.js"><link rel="prefetch" href="/Odyssey/assets/js/57.9463926d.js"><link rel="prefetch" href="/Odyssey/assets/js/58.73a73232.js"><link rel="prefetch" href="/Odyssey/assets/js/59.3a3e853e.js"><link rel="prefetch" href="/Odyssey/assets/js/6.348464c7.js"><link rel="prefetch" href="/Odyssey/assets/js/60.9c66dd2d.js"><link rel="prefetch" href="/Odyssey/assets/js/61.ee0b9a8b.js"><link rel="prefetch" href="/Odyssey/assets/js/62.76d18fcb.js"><link rel="prefetch" href="/Odyssey/assets/js/63.dd25e434.js"><link rel="prefetch" href="/Odyssey/assets/js/64.f2cd0b44.js"><link rel="prefetch" href="/Odyssey/assets/js/65.47204a7c.js"><link rel="prefetch" href="/Odyssey/assets/js/66.605a4a82.js"><link rel="prefetch" href="/Odyssey/assets/js/67.34132ce0.js"><link rel="prefetch" href="/Odyssey/assets/js/68.f3bcfc00.js"><link rel="prefetch" href="/Odyssey/assets/js/69.3640c28b.js"><link rel="prefetch" href="/Odyssey/assets/js/7.869b5935.js"><link rel="prefetch" href="/Odyssey/assets/js/70.e2a8446b.js"><link rel="prefetch" href="/Odyssey/assets/js/71.c9f6b4d3.js"><link rel="prefetch" href="/Odyssey/assets/js/72.201bfcc2.js"><link rel="prefetch" href="/Odyssey/assets/js/73.7e8e995e.js"><link rel="prefetch" href="/Odyssey/assets/js/74.ea2a2167.js"><link rel="prefetch" href="/Odyssey/assets/js/75.7009c10e.js"><link rel="prefetch" href="/Odyssey/assets/js/76.48b75434.js"><link rel="prefetch" href="/Odyssey/assets/js/77.fa8e9cd3.js"><link rel="prefetch" href="/Odyssey/assets/js/78.5cb5a672.js"><link rel="prefetch" href="/Odyssey/assets/js/79.5adebe29.js"><link rel="prefetch" href="/Odyssey/assets/js/8.a0861537.js"><link rel="prefetch" href="/Odyssey/assets/js/80.fcb9624a.js"><link rel="prefetch" href="/Odyssey/assets/js/81.42c49b3a.js"><link rel="prefetch" href="/Odyssey/assets/js/82.477309e7.js"><link rel="prefetch" href="/Odyssey/assets/js/83.38767490.js"><link rel="prefetch" href="/Odyssey/assets/js/84.c80b8f93.js"><link rel="prefetch" href="/Odyssey/assets/js/85.b1ca1383.js"><link rel="prefetch" href="/Odyssey/assets/js/86.0bb83cf2.js"><link rel="prefetch" href="/Odyssey/assets/js/87.632e928e.js"><link rel="prefetch" href="/Odyssey/assets/js/88.924c9285.js"><link rel="prefetch" href="/Odyssey/assets/js/89.34d3c3ff.js"><link rel="prefetch" href="/Odyssey/assets/js/9.14a4b067.js"><link rel="prefetch" href="/Odyssey/assets/js/90.2e394c85.js"><link rel="prefetch" href="/Odyssey/assets/js/91.b604e092.js"><link rel="prefetch" href="/Odyssey/assets/js/92.94b169d8.js"><link rel="prefetch" href="/Odyssey/assets/js/93.0e2742ef.js"><link rel="prefetch" href="/Odyssey/assets/js/94.449bcab7.js"><link rel="prefetch" href="/Odyssey/assets/js/95.250c02be.js"><link rel="prefetch" href="/Odyssey/assets/js/96.eee6aed4.js"><link rel="prefetch" href="/Odyssey/assets/js/97.3198ad58.js"><link rel="prefetch" href="/Odyssey/assets/js/98.1b0a34c9.js"><link rel="prefetch" href="/Odyssey/assets/js/99.9021c172.js">
    <link rel="stylesheet" href="/Odyssey/assets/css/0.styles.35a5e89f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Odyssey/" class="home-link router-link-active"><!----> <span class="site-name">Hungry&amp;Eating</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Odyssey/reading/" class="nav-link router-link-active">
  阅读
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机综合" class="dropdown-title"><span class="title">学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机综合" class="mobile-dropdown-title"><span class="title">学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Odyssey/cache/" class="nav-link">
  缓存
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/code/" class="nav-link">
  coding
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/struct/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/db/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/storage/" class="nav-link">
  存储
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/protocol/" class="nav-link">
  协议
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/network/" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/design/" class="nav-link">
  设计
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/web/" class="nav-link">
  www
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/insight/" class="nav-link">
  理解
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/unclassified/" class="nav-link">
  未分类
</a></li></ul></div></div> <a href="https://github.com/firekillice/Odyssey" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Odyssey/reading/" class="nav-link router-link-active">
  阅读
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机综合" class="dropdown-title"><span class="title">学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机综合" class="mobile-dropdown-title"><span class="title">学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Odyssey/cache/" class="nav-link">
  缓存
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/code/" class="nav-link">
  coding
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/struct/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/db/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/storage/" class="nav-link">
  存储
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/protocol/" class="nav-link">
  协议
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/network/" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/design/" class="nav-link">
  设计
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/web/" class="nav-link">
  www
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/insight/" class="nav-link">
  理解
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/unclassified/" class="nav-link">
  未分类
</a></li></ul></div></div> <a href="https://github.com/firekillice/Odyssey" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/Odyssey/reading/" aria-current="page" class="sidebar-link">阅读栏目的入口</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>阅读</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Odyssey/reading/system/Introduction to Computing System.html" class="sidebar-link">计算机系统概论</a></li><li><a href="/Odyssey/reading/system/CSAPP.html" class="sidebar-link">深入理解计算机系统</a></li><li><a href="/Odyssey/reading/system/compile-principle.html" class="sidebar-link">编译器原理</a></li><li><a href="/Odyssey/reading/source/mongo.html" aria-current="page" class="active sidebar-link">mongo代码阅读</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Odyssey/reading/source/mongo.html#requirement" class="sidebar-link">requirement</a></li><li class="sidebar-sub-header"><a href="/Odyssey/reading/source/mongo.html#compile" class="sidebar-link">compile</a></li><li class="sidebar-sub-header"><a href="/Odyssey/reading/source/mongo.html#网络模块" class="sidebar-link">网络模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Odyssey/reading/source/mongo.html#基本流程" class="sidebar-link">基本流程</a></li><li class="sidebar-sub-header"><a href="/Odyssey/reading/source/mongo.html#gdb" class="sidebar-link">gdb</a></li></ul></li><li class="sidebar-sub-header"><a href="/Odyssey/reading/source/mongo.html#查询请求" class="sidebar-link">查询请求</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Odyssey/reading/source/mongo.html#索引" class="sidebar-link">索引</a></li><li class="sidebar-sub-header"><a href="/Odyssey/reading/source/mongo.html#游标" class="sidebar-link">游标</a></li><li class="sidebar-sub-header"><a href="/Odyssey/reading/source/mongo.html#gdb-breakpoints" class="sidebar-link">gdb breakpoints</a></li></ul></li><li class="sidebar-sub-header"><a href="/Odyssey/reading/source/mongo.html#创建数据库" class="sidebar-link">创建数据库</a></li><li class="sidebar-sub-header"><a href="/Odyssey/reading/source/mongo.html#探索存储" class="sidebar-link">探索存储</a></li><li class="sidebar-sub-header"><a href="/Odyssey/reading/source/mongo.html#gossip" class="sidebar-link">gossip</a></li><li class="sidebar-sub-header"><a href="/Odyssey/reading/source/mongo.html#problem" class="sidebar-link">problem</a></li><li class="sidebar-sub-header"><a href="/Odyssey/reading/source/mongo.html#gdb-配置" class="sidebar-link">gdb 配置</a></li><li class="sidebar-sub-header"><a href="/Odyssey/reading/source/mongo.html#出现的问题" class="sidebar-link">出现的问题</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mongo代码阅读"><a href="#mongo代码阅读" class="header-anchor">#</a> mongo代码阅读</h1> <ul><li>version: v3.6</li></ul> <h2 id="requirement"><a href="#requirement" class="header-anchor">#</a> requirement</h2> <ul><li>gcc version 5.4 (GCC)</li> <li>python2.7</li> <li>scons 3.0.1</li> <li>机器有4G+的内存</li></ul> <h2 id="compile"><a href="#compile" class="header-anchor">#</a> compile</h2> <ul><li>调试模式编译mongod</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>python2 buildscripts/scons.py --gdbserver=GDBSERVER -j 2  mongod
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="网络模块"><a href="#网络模块" class="header-anchor">#</a> 网络模块</h2> <h3 id="基本流程"><a href="#基本流程" class="header-anchor">#</a> 基本流程<br></h3> <ul><li><p>mongodb-3.6版本的网络结构<br> <img src="/Odyssey/assets/img/transport-layer-v3.6.da6b525d.png" alt="网络数据流程-mongodb-v3.6"></p></li> <li><p>mongodb-4.4版本的网络结构<br> <img src="/Odyssey/assets/img/transport-layer-v4.4.ff271c00.png" alt="网络数据流程-mongodb-v4.4"></p></li> <li><p>对比3.6和4.4版本，一个明显的变化就是ticket被移除了</p></li></ul> <h3 id="gdb"><a href="#gdb" class="header-anchor">#</a> gdb</h3> <h4 id="breakpoints"><a href="#breakpoints" class="header-anchor">#</a> breakpoints</h4> <ul><li>b  mongo::ServiceEntryPointMongod::handleRequest</li> <li>b find.cpp:564</li> <li>b mongo::launchServiceWorkerThread</li></ul> <h4 id="gdb-insight"><a href="#gdb-insight" class="header-anchor">#</a> gdb insight</h4> <ul><li>查看连接使用的线程的backStrace： 从下文的引用中可以看出，每个连接占用了2个线程，并且有&quot;conn1&quot;和&quot;conn2&quot;已经退出</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>info threads
  Id   Target Id         Frame 
* 32   Thread 0x7ffff7fdb700 (LWP 8401) &quot;conn4&quot; mongo::ServiceEntryPointMongod::handleRequest (this=0x555558fea980, opCtx=0x55555cc56680, m=...)
    at src/mongo/db/service_entry_point_mongod.cpp:1105
  31   Thread 0x7fffeb123700 (LWP 8391) &quot;conn3&quot; 0x00007ffff6d16c4d in recvmsg () from /lib64/libpthread.so.0
  28   Thread 0x7fffeb924700 (LWP 8376) &quot;listener&quot; 0x00007ffff6a3a183 in epoll_wait () from /lib64/libc.so.6
  27   Thread 0x7fffec125700 (LWP 8375) &quot;Logical.cheReap&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  26   Thread 0x7fffec926700 (LWP 8374) &quot;Logical.Refresh&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  25   Thread 0x7fffed127700 (LWP 8373) &quot;mongod&quot; 0x00007ffff6d13995 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  24   Thread 0x7fffed928700 (LWP 8372) &quot;Periodi.kRunner&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  23   Thread 0x7fffee129700 (LWP 8371) &quot;clientcursormon&quot; 0x00007ffff6d16f3d in nanosleep () from /lib64/libpthread.so.0
  22   Thread 0x7fffee92a700 (LWP 8370) &quot;TTLMonitor&quot; 0x00007ffff6d16f3d in nanosleep () from /lib64/libpthread.so.0
  21   Thread 0x7fffef12b700 (LWP 8369) &quot;ftdc&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  20   Thread 0x7fffef92c700 (LWP 8368) &quot;Network.cutor-0&quot; 0x00007ffff6d13995 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  19   Thread 0x7ffff012d700 (LWP 8367) &quot;DeadlineMonitor&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  18   Thread 0x7ffff092e700 (LWP 8366) &quot;WTCheck.tThread&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  17   Thread 0x7ffff112f700 (LWP 8365) &quot;WTJourn.Flusher&quot; 0x00007ffff6d16f3d in nanosleep () from /lib64/libpthread.so.0
  16   Thread 0x7ffff1930700 (LWP 8364) &quot;WTIdleS.Sweeper&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  15   Thread 0x7ffff2131700 (LWP 8363) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  14   Thread 0x7ffff2932700 (LWP 8362) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  13   Thread 0x7ffff3133700 (LWP 8361) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  12   Thread 0x7ffff3934700 (LWP 8360) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  11   Thread 0x7ffff4135700 (LWP 8359) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  10   Thread 0x7ffff4936700 (LWP 8358) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  9    Thread 0x7ffff5137700 (LWP 8357) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  8    Thread 0x7ffff5938700 (LWP 8356) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  3    Thread 0x7ffff6139700 (LWP 8350) &quot;Backgro.kSource&quot; 0x00007ffff6d13995 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  2    Thread 0x7ffff693a700 (LWP 8349) &quot;signalP.gThread&quot; 0x00007ffff6d17461 in sigwait () from /lib64/libpthread.so.0
  1    Thread 0x7ffff7fdea40 (LWP 8348) &quot;mongod&quot; 0x00007ffff6d13995 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><ul><li>查看处理请求线程的backStrace <br></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>&gt; bt
#0  mongo::ServiceEntryPointMongod::handleRequest (this=0x555558fea980, opCtx=0x55555cc56680, m=...) at src/mongo/db/service_entry_point_mongod.cpp:1105
#1  0x000055555613810a in mongo::ServiceStateMachine::_processMessage (this=0x55555cbc2190, guard=...) at src/mongo/transport/service_state_machine.cpp:370
#2  0x0000555556132b17 in mongo::ServiceStateMachine::_runNextInGuard (this=0x55555cbc2190, guard=...) at src/mongo/transport/service_state_machine.cpp:431
#3  0x0000555556136f01 in operator() (__closure=0x55555cf025a0) at src/mongo/transport/service_state_machine.cpp:475
#4  std::_Function_handler&lt;void(), mongo::ServiceStateMachine::_scheduleNextWithGuard(mongo::ServiceStateMachine::ThreadGuard, mongo::transport::ServiceExecutor::ScheduleFlags, mongo::transport::ServiceExecutorTaskName, mongo::ServiceStateMachine::Ownership)::&lt;lambda()&gt; &gt;::_M_invoke(const std::_Any_data &amp;) (__functor=...)
    at /usr/local/include/c++/5.4.0/functional:1871
#5  0x000055555708f4b2 in operator() (this=0x7ffff7fda4f0) at /usr/local/include/c++/5.4.0/functional:2267
#6  mongo::transport::ServiceExecutorSynchronous::schedule(std::function&lt;void ()&gt;, mongo::transport::ServiceExecutor::ScheduleFlags, mongo::transport::ServiceExecutorTaskName) (this=0x555558db4580, task=..., flags=flags@entry=mongo::transport::ServiceExecutor::kMayRecurse, taskName=taskName@entry=mongo::transport::kSSMProcessMessage)
    at src/mongo/transport/service_executor_synchronous.cpp:117
#7  0x0000555556131950 in mongo::ServiceStateMachine::_scheduleNextWithGuard (this=this@entry=0x55555cbc2190, guard=..., 
    flags=flags@entry=mongo::transport::ServiceExecutor::kMayRecurse, taskName=taskName@entry=mongo::transport::kSSMProcessMessage, 
    ownershipModel=ownershipModel@entry=mongo::ServiceStateMachine::kOwned) at src/mongo/transport/service_state_machine.cpp:478
#8  0x0000555556134254 in mongo::ServiceStateMachine::_sourceCallback (this=this@entry=0x55555cbc2190, status=...) at src/mongo/transport/service_state_machine.cpp:297
#9  0x0000555556134fd1 in mongo::ServiceStateMachine::_sourceMessage (this=this@entry=0x55555cbc2190, guard=...) at src/mongo/transport/service_state_machine.cpp:254
#10 0x0000555556132b9d in mongo::ServiceStateMachine::_runNextInGuard (this=0x55555cbc2190, guard=...) at src/mongo/transport/service_state_machine.cpp:428
#11 0x0000555556136f01 in operator() (__closure=0x55555cf023c0) at src/mongo/transport/service_state_machine.cpp:475
#12 std::_Function_handler&lt;void(), mongo::ServiceStateMachine::_scheduleNextWithGuard(mongo::ServiceStateMachine::ThreadGuard, mongo::transport::ServiceExecutor::ScheduleFlags, mongo::transport::ServiceExecutorTaskName, mongo::ServiceStateMachine::Ownership)::&lt;lambda()&gt; &gt;::_M_invoke(const std::_Any_data &amp;) (__functor=...)
    at /usr/local/include/c++/5.4.0/functional:1871
#13 0x000055555708fa15 in operator() (this=&lt;optimized out&gt;) at /usr/local/include/c++/5.4.0/functional:2267
#14 operator() (__closure=0x555558fa3f30) at src/mongo/transport/service_executor_synchronous.cpp:134
#15 std::_Function_handler&lt;void(), mongo::transport::ServiceExecutorSynchronous::schedule(mongo::transport::ServiceExecutor::Task, mongo::transport::ServiceExecutor::ScheduleFlags, mongo::transport::ServiceExecutorTaskName)::&lt;lambda()&gt; &gt;::_M_invoke(const std::_Any_data &amp;) (__functor=...) at /usr/local/include/c++/5.4.0/functional:1871
#16 0x000055555763d664 in operator() (this=&lt;optimized out&gt;) at /usr/local/include/c++/5.4.0/functional:2267
#17 mongo::(anonymous namespace)::runFunc (ctx=0x55555cf02620) at src/mongo/transport/service_entry_point_utils.cpp:57
#18 0x00007ffff6d0fe25 in start_thread () from /lib64/libpthread.so.0
#19 0x00007ffff6a39bad in clone () from /lib64/libc.so.6
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><ul><li>查看建立连接线程的过程<br></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code> bt
#0  mongo::launchServiceWorkerThread(std::function&lt;void ()&gt;) (task=...) at src/mongo/transport/service_entry_point_utils.cpp:70
#1  0x000055555708f60f in mongo::transport::ServiceExecutorSynchronous::schedule(std::function&lt;void ()&gt;, mongo::transport::ServiceExecutor::ScheduleFlags, mongo::transport::ServiceExecutorTaskName) (this=0x555558db4580, task=..., flags=flags@entry=mongo::transport::ServiceExecutor::kEmptyFlags, 
    taskName=taskName@entry=mongo::transport::kSSMStartSession) at src/mongo/transport/service_executor_synchronous.cpp:141
#2  0x0000555556131950 in mongo::ServiceStateMachine::_scheduleNextWithGuard (this=this@entry=0x55555cbc1d30, guard=..., 
    flags=flags@entry=mongo::transport::ServiceExecutor::kEmptyFlags, taskName=taskName@entry=mongo::transport::kSSMStartSession, 
    ownershipModel=ownershipModel@entry=mongo::ServiceStateMachine::kStatic) at src/mongo/transport/service_state_machine.cpp:478
#3  0x000055555613215a in mongo::ServiceStateMachine::start (this=0x55555cbc1d30, ownershipModel=mongo::ServiceStateMachine::kStatic)
    at src/mongo/transport/service_state_machine.cpp:460
#4  0x000055555612e581 in mongo::ServiceEntryPointImpl::startSession (this=&lt;optimized out&gt;, session=...) at src/mongo/transport/service_entry_point_impl.cpp:192
#5  0x000055555729e1d8 in operator() (peerSocket=..., ec=..., __closure=0x7fffeb923130, this=&lt;optimized out&gt;) at src/mongo/transport/transport_layer_asio.cpp:334
#6  operator() (this=0x7fffeb923130) at src/third_party/asio-master/asio/include/asio/detail/bind_handler.hpp:308
#7  asio_handler_invoke&lt;asio::detail::move_binder2&lt;mongo::transport::TransportLayerASIO::_acceptConnection(mongo::transport::TransportLayerASIO::GenericAcceptor&amp;)::&lt;lambda(const std::error_code&amp;, mongo::transport::GenericSocket)&gt;, std::error_code, asio::basic_stream_socket&lt;asio::generic::stream_protocol&gt; &gt; &gt; (function=...)
    at src/third_party/asio-master/asio/include/asio/handler_invoke_hook.hpp:68
#8  invoke&lt;asio::detail::move_binder2&lt;mongo::transport::TransportLayerASIO::_acceptConnection(mongo::transport::TransportLayerASIO::GenericAcceptor&amp;)::&lt;lambda(const std::error_code&amp;, mongo::transport::GenericSocket)&gt;, std::error_code, asio::basic_stream_socket&lt;asio::generic::stream_protocol&gt; &gt;, mongo::transport::TransportLayerASIO::_acceptConnection(mongo::transport::TransportLayerASIO::GenericAcceptor&amp;)::&lt;lambda(const std::error_code&amp;, mongo::transport::GenericSocket)&gt; &gt; (context=..., function=...)
    at src/third_party/asio-master/asio/include/asio/detail/handler_invoke_helpers.hpp:37
#9  complete&lt;asio::detail::move_binder2&lt;mongo::transport::TransportLayerASIO::_acceptConnection(mongo::transport::TransportLayerASIO::GenericAcceptor&amp;)::&lt;lambda(const std::error_code&amp;, mongo::transport::GenericSocket)&gt;, std::error_code, asio::basic_stream_socket&lt;asio::generic::stream_protocol&gt; &gt; &gt; (this=&lt;synthetic pointer&gt;, handler=..., 
    function=...) at src/third_party/asio-master/asio/include/asio/detail/handler_work.hpp:81
#10 asio::detail::reactive_socket_move_accept_op&lt;asio::generic::stream_protocol, mongo::transport::TransportLayerASIO::_acceptConnection(mongo::transport::TransportLayerASIO::GenericAcceptor&amp;)::&lt;lambda(const std::error_code&amp;, mongo::transport::GenericSocket)&gt; &gt;::do_complete(void *, asio::detail::operation *, const asio::error_code &amp;, std::size_t) (owner=&lt;optimized out&gt;, base=&lt;optimized out&gt;) at src/third_party/asio-master/asio/include/asio/detail/reactive_socket_accept_op.hpp:201
#11 0x00005555572aa309 in complete (bytes_transferred=&lt;optimized out&gt;, ec=..., owner=0x5555591ad200, this=&lt;optimized out&gt;)
    at src/third_party/asio-master/asio/include/asio/detail/scheduler_operation.hpp:39
#12 asio::detail::scheduler::do_run_one (this=this@entry=0x5555591ad200, lock=..., this_thread=..., ec=...)
    at src/third_party/asio-master/asio/include/asio/detail/impl/scheduler.ipp:400
#13 0x00005555572aa551 in asio::detail::scheduler::run (this=0x5555591ad200, ec=...) at src/third_party/asio-master/asio/include/asio/detail/impl/scheduler.ipp:153
#14 0x00005555572b479e in asio::io_context::run (this=0x5555591a32f0) at src/third_party/asio-master/asio/include/asio/impl/io_context.ipp:61
#15 0x000055555729bc7e in operator() (__closure=0x555558e90228) at src/mongo/transport/transport_layer_asio.cpp:253
#16 _M_invoke&lt;&gt; (this=0x555558e90228) at /usr/local/include/c++/5.4.0/functional:1531
#17 operator() (this=0x555558e90228) at /usr/local/include/c++/5.4.0/functional:1520
#18 std::thread::_Impl&lt;std::_Bind_simple&lt;mongo::transport::TransportLayerASIO::start()::&lt;lambda()&gt;()&gt; &gt;::_M_run(void) (this=0x555558e90210)
    at /usr/local/include/c++/5.4.0/thread:115
#19 0x00007ffff74f2670 in std::execute_native_thread_routine (__p=&lt;optimized out&gt;) at ../../../../../gcc-5.4.0/libstdc++-v3/src/c++11/thread.cc:84
#20 0x00007ffff6d0fe25 in start_thread () from /lib64/libpthread.so.0
#21 0x00007ffff6a39bad in clone () from /lib64/libc.so.6

--------------------------------------------------------------------------------------------------------------------------------------------------------
连接线程从listener线程中创建出来
info threads
  Id   Target Id         Frame 
* 28   Thread 0x7fffeb924700 (LWP 8680) &quot;listener&quot; mongo::launchServiceWorkerThread(std::function&lt;void ()&gt;) (task=...)
    at src/mongo/transport/service_entry_point_utils.cpp:70
  27   Thread 0x7fffec125700 (LWP 8679) &quot;Logical.cheReap&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  26   Thread 0x7fffec926700 (LWP 8678) &quot;Logical.Refresh&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  25   Thread 0x7fffed127700 (LWP 8677) &quot;mongod&quot; 0x00007ffff6d13995 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  24   Thread 0x7fffed928700 (LWP 8676) &quot;Periodi.kRunner&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  23   Thread 0x7fffee129700 (LWP 8675) &quot;clientcursormon&quot; 0x00007ffff6d16f3d in nanosleep () from /lib64/libpthread.so.0
  22   Thread 0x7fffee92a700 (LWP 8674) &quot;TTLMonitor&quot; 0x00007ffff6d16f3d in nanosleep () from /lib64/libpthread.so.0
  21   Thread 0x7fffef12b700 (LWP 8673) &quot;ftdc&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  20   Thread 0x7fffef92c700 (LWP 8672) &quot;Network.cutor-0&quot; 0x00007ffff6d13995 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  19   Thread 0x7ffff012d700 (LWP 8671) &quot;DeadlineMonitor&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  18   Thread 0x7ffff092e700 (LWP 8670) &quot;WTCheck.tThread&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  17   Thread 0x7ffff112f700 (LWP 8669) &quot;WTJourn.Flusher&quot; 0x00007ffff6d16f3d in nanosleep () from /lib64/libpthread.so.0
  16   Thread 0x7ffff1930700 (LWP 8668) &quot;WTIdleS.Sweeper&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  15   Thread 0x7ffff2131700 (LWP 8667) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  14   Thread 0x7ffff2932700 (LWP 8666) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  13   Thread 0x7ffff3133700 (LWP 8665) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  12   Thread 0x7ffff3934700 (LWP 8664) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  11   Thread 0x7ffff4135700 (LWP 8663) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  10   Thread 0x7ffff4936700 (LWP 8662) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  9    Thread 0x7ffff5137700 (LWP 8661) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  8    Thread 0x7ffff5938700 (LWP 8660) &quot;mongod&quot; 0x00007ffff6d13d42 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  3    Thread 0x7ffff6139700 (LWP 8655) &quot;Backgro.kSource&quot; 0x00007ffff6d13995 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
  2    Thread 0x7ffff693a700 (LWP 8654) &quot;signalP.gThread&quot; 0x00007ffff6d17461 in sigwait () from /lib64/libpthread.so.0
  1    Thread 0x7ffff7fdea40 (LWP 8653) &quot;mongod&quot; 0x00007ffff6d13995 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h2 id="查询请求"><a href="#查询请求" class="header-anchor">#</a> 查询请求</h2> <ul><li>find请求的数据抓包<br> <img src="/Odyssey/assets/img/dbmsg-wireshark-capture-find.5547e5e3.png" alt="find-wireshark-capture"></li> <li>数据处理的简单流程，包括findCmd、getMoreCmd，规范化，生成查询计划，数据的获取与使用，查询信息的生命周期等<br> <img src="/Odyssey/assets/img/db-find-overview.91143d47.png" alt="find-and-sort-overview"></li></ul> <h3 id="索引"><a href="#索引" class="header-anchor">#</a> 索引</h3> <ul><li>使用索引后的执行流程</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>#0  mongo::IndexScan::doWork (this=0x55555cc38200, out=0x7fffeb11f130) at src/mongo/db/exec/index_scan.cpp:138
#1  0x000055555675923b in mongo::PlanStage::work (this=0x55555cc38200, out=0x7fffeb11f130) at src/mongo/db/exec/plan_stage.cpp:48
#2  0x0000555556734116 in mongo::FetchStage::doWork (this=0x55555cbda340, out=0x7fffeb11f300) at src/mongo/db/exec/fetch.cpp:88
#3  0x000055555675923b in mongo::PlanStage::work (this=0x55555cbda340, out=out@entry=0x7fffeb11f300) at src/mongo/db/exec/plan_stage.cpp:48
#4  0x000055555676b07f in mongo::SortKeyGeneratorStage::doWork (this=0x55555d478300, out=0x7fffeb11f300) at src/mongo/db/exec/sort_key_generator.cpp:73
#5  0x000055555675923b in mongo::PlanStage::work (this=0x55555d478300, out=out@entry=0x7fffeb11f300) at src/mongo/db/exec/plan_stage.cpp:48
#6  0x0000555556767b1e in mongo::SortStage::doWork (this=0x55555d469300, out=0x7fffeb11f410) at src/mongo/db/exec/sort.cpp:123
#7  0x000055555675923b in mongo::PlanStage::work (this=0x55555d469300, out=out@entry=0x7fffeb11f410) at src/mongo/db/exec/plan_stage.cpp:48
#8  0x000055555651a3fe in mongo::PlanExecutor::getNextImpl (this=0x55555cc47100, objOut=objOut@entry=0x7fffeb11f510, dlOut=dlOut@entry=0x0)
    at src/mongo/db/query/plan_executor.cpp:568
#9  0x000055555651af2b in mongo::PlanExecutor::getNext (this=&lt;optimized out&gt;, objOut=objOut@entry=0x7fffeb11f620, dlOut=dlOut@entry=0x0)
    at src/mongo/db/query/plan_executor.cpp:411
#10 0x0000555556180183 in mongo::(anonymous namespace)::FindCmd::run (this=this@entry=0x5555584fbba0 &lt;mongo::(anonymous namespace)::findCmd&gt;,
....
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="游标"><a href="#游标" class="header-anchor">#</a> 游标</h3> <ul><li>mongod和driver之间共享一个cursorId，通过该id进行数据传递</li> <li>数据在getMore之前被全部从存储引擎中取出放入到缓存中，getMore直接取数据</li></ul> <h3 id="gdb-breakpoints"><a href="#gdb-breakpoints" class="header-anchor">#</a> gdb breakpoints</h3> <ul><li>b receivedQuery</li> <li>b mongo::(anonymous namespace)::execCommandDatabase，匿名空间的断点</li> <li>b mongo::BasicCommand::enhancedRun</li> <li>b mongo::FetchStage::doWork</li> <li>b mongo::SortStage::doWork</li> <li>b mongo::ServiceEntryPointMongod::handleRequest</li> <li>b mongo::WiredTigerRecordStoreCursorBase::seekExact</li> <li>b __wt_cursor_get_keyv</li> <li>b mongo::(anonymous namespace)::FindCmd::run</li> <li>b mongo::CollectionScan::doWork</li> <li>b mongo::PlanExecutor::getNextImpl</li></ul> <h2 id="创建数据库"><a href="#创建数据库" class="header-anchor">#</a> 创建数据库</h2> <ul><li>堆栈<br></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>&gt; use study;
&gt; db.teacher.insert({&quot;name&quot;:&quot;jack&quot;, &quot;age&quot;:30});
-------------------------------------------------------------------------------------------------------------------------------------
ns: study.teacher
ident: collection-3-2344499213559005060(最终落地的文件名)
-------------------------------------------------------------------------------------------------------------------------------------
#0  mongo::WiredTigerKVEngine::createGroupedRecordStore (this=0x5555591a76c0, opCtx=0x55555cc44b40, ns=..., ident=..., options=..., prefix=...)
    at src/mongo/db/storage/wiredtiger/wiredtiger_kv_engine.cpp:768
#1  0x00005555560ad97f in mongo::KVDatabaseCatalogEntryBase::createCollection (this=0x555558e4df60, opCtx=0x55555cc44b40, ns=..., options=..., allocateDefaultSpace=true)
    at src/mongo/db/storage/kv/kv_database_catalog_entry_base.cpp:221
#2  0x000055555622ff35 in mongo::DatabaseImpl::createCollection (this=0x555558fc6180, opCtx=0x55555cc44b40, ns=..., options=..., createIdIndex=&lt;optimized out&gt;, 
    idIndex=...) at src/mongo/db/catalog/database_impl.cpp:824
#3  0x000055555622a9df in createCollection (idIndex=..., createDefaultIndexes=true, options=..., ns=..., opCtx=0x55555cc44b40, this=0x555558dbffd0)
    at src/mongo/db/catalog/database.h:293
#4  mongo::userCreateNSImpl (opCtx=0x55555cc44b40, db=0x555558dbffd0, ns=..., options=..., parseKind=mongo::CollectionOptions::parseForCommand, 
    createDefaultIndexes=true, idIndex=...) at src/mongo/db/catalog/database_impl.cpp:1122
#5  0x000055555623214f in std::_Function_handler&lt;mongo::Status (mongo::OperationContext*, mongo::Database*, mongo::StringData, mongo::BSONObj, mongo::CollectionOptions::ParseKind, bool, mongo::BSONObj const&amp;), mongo::Status (*)(mongo::OperationContext*, mongo::Database*, mongo::StringData, mongo::BSONObj, mongo::CollectionOptions::ParseKind, bool, mongo::BSONObj const&amp;)&gt;::_M_invoke(std::_Any_data const&amp;, mongo::OperationContext*&amp;&amp;, mongo::Database*&amp;&amp;, mongo::StringData&amp;&amp;, mongo::BSONObj&amp;&amp;, mongo::CollectionOptions::ParseKind&amp;&amp;, bool&amp;&amp;, mongo::BSONObj const&amp;) (__functor=..., __args#0=&lt;optimized out&gt;, __args#1=&lt;optimized out&gt;, __args#2=&lt;optimized out&gt;, 
    __args#3=&lt;optimized out&gt;, __args#4=&lt;unknown type in /home/sandstone/workpath/github/mongo-3.6-reading/mongod, CU 0x76848c7, DIE 0x77e67b5&gt;, 
    __args#5=&lt;unknown type in /home/sandstone/workpath/github/mongo-3.6-reading/mongod, CU 0x76848c7, DIE 0x77e67ba&gt;, __args#6=...)
    at /usr/local/include/c++/5.4.0/functional:1857
#6  0x000055555751e5fe in operator() (__args#6=..., __args#5=true, __args#4=mongo::CollectionOptions::parseForCommand, 
    __args#3=&lt;error reading variable: access outside bounds of object referenced via synthetic pointer&gt;, __args#2=..., __args#1=0x555558dbffd0, __args#0=0x55555cc44b40, 
    this=0x55555851ec60 &lt;mongo::(anonymous namespace)::userCreateNSImpl&gt;) at /usr/local/include/c++/5.4.0/functional:2267
#7  mongo::userCreateNS (opCtx=&lt;optimized out&gt;, db=&lt;optimized out&gt;, ns=..., options=..., parseKind=mongo::CollectionOptions::parseForCommand, createDefaultIndexes=true, 
    idIndex=...) at src/mongo/db/catalog/database.cpp:83
#8  0x0000555556200f07 in mongo::(anonymous namespace)::&lt;lambda()&gt;::operator()(void) const (__closure=__closure@entry=0x7ffff7fd66d0)
    at src/mongo/db/ops/write_ops_exec.cpp:199
#9  0x00005555562010cc in writeConflictRetry&lt;mongo::(anonymous namespace)::makeCollection(mongo::OperationContext*, const mongo::NamespaceString&amp;)::&lt;lambda()&gt; &gt; (
    f=&lt;unknown type in /home/sandstone/workpath/github/mongo-3.6-reading/mongod, CU 0x6f59372, DIE 0x70cab53&gt;, ns=..., opStr=..., opCtx=0x55555cc44b40)
    at src/mongo/db/concurrency/write_conflict_exception.h:93
#10 mongo::(anonymous namespace)::makeCollection (opCtx=0x55555cc44b40, ns=...) at src/mongo/db/ops/write_ops_exec.cpp:202
#11 0x00005555562012a6 in mongo::(anonymous namespace)::&lt;lambda()&gt;::operator()(void) const (__closure=0x7ffff7fd6940) at src/mongo/db/ops/write_ops_exec.cpp:376
#12 0x00005555562012a6 in mongo::performInserts (opCtx=&lt;optimized out&gt;, wholeOp=..., fromMigrate=&lt;optimized out&gt;)
#13 0x0000555556205bcf in insertBatchAndHandleErrors (fromMigrate=false, out=0x7ffff7fd6920, lastOpFixer=0x7ffff7fd6900, batch=..., wholeOp=..., opCtx=0x55555cc44b40)
    at src/mongo/db/ops/write_ops_exec.cpp:386
#14 mongo::performInserts (opCtx=opCtx@entry=0x55555cc44b40, wholeOp=..., fromMigrate=fromMigrate@entry=false) at src/mongo/db/ops/write_ops_exec.cpp:540
#15 0x00005555561ec120 in mongo::(anonymous namespace)::CmdInsert::runImpl (this=&lt;optimized out&gt;, opCtx=0x55555cc44b40, request=..., result=...)
    at src/mongo/db/commands/write_commands/write_commands.cpp:257
#16 0x00005555561e5e08 in mongo::(anonymous namespace)::WriteCommand::enhancedRun (this=&lt;optimized out&gt;, opCtx=0x55555cc44b40, request=..., result=...)
    at src/mongo/db/commands/write_commands/write_commands.cpp:223
#17 0x00005555570b81af in mongo::Command::publicRun (this=0x5555584feda0 &lt;mongo::(anonymous namespace)::cmdInsert&gt;, opCtx=0x55555cc44b40, request=..., result=...)
    at src/mongo/db/commands.cpp:366
#18 0x0000555556125d79 in runCommandImpl (startOperationTime=..., replyBuilder=0x555558fb4f50, request=..., 
    command=0x5555584feda0 &lt;mongo::(anonymous namespace)::cmdInsert&gt;, opCtx=0x55555cc44b40, this=&lt;optimized out&gt;) at src/mongo/db/service_entry_point_mongod.cpp:511
#19 mongo::(anonymous namespace)::execCommandDatabase (opCtx=&lt;optimized out&gt;, command=command@entry=0x5555584feda0 &lt;mongo::(anonymous namespace)::cmdInsert&gt;, 
    request=..., replyBuilder=&lt;optimized out&gt;, this=&lt;optimized out&gt;, this=&lt;optimized out&gt;) at src/mongo/db/service_entry_point_mongod.cpp:768
#20 0x000055555612703c in mongo::(anonymous namespace)::&lt;lambda()&gt;::operator()(void) const (__closure=__closure@entry=0x7ffff7fd6ab0)
    at src/mongo/db/service_entry_point_mongod.cpp:882
#21 0x000055555612703c in mongo::ServiceEntryPointMongod::handleRequest (this=&lt;optimized out&gt;, opCtx=&lt;optimized out&gt;, m=...)
#22 0x0000555556128060 in runCommands (message=..., opCtx=0x55555cc44b40) at src/mongo/db/service_entry_point_mongod.cpp:895
#23 mongo::ServiceEntryPointMongod::handleRequest (this=&lt;optimized out&gt;, opCtx=0x55555cc44b40, m=...) at src/mongo/db/service_entry_point_mongod.cpp:1150
#24 0x000055555613810a in mongo::ServiceStateMachine::_processMessage (this=0x55555cbd9d30, guard=...) at src/mongo/transport/service_state_machine.cpp:370
#25 0x0000555556132b17 in mongo::ServiceStateMachine::_runNextInGuard (this=0x55555cbd9d30, guard=...) at src/mongo/transport/service_state_machine.cpp:431
#26 0x0000555556136f01 in operator() (__closure=0x55555cc6cac0) at src/mongo/transport/service_state_machine.cpp:475
#27 std::_Function_handler&lt;void(), mongo::ServiceStateMachine::_scheduleNextWithGuard(mongo::ServiceStateMachine::ThreadGuard, mongo::transport::ServiceExecutor::ScheduleFlags, mongo::transport::ServiceExecutorTaskName, mongo::ServiceStateMachine::Ownership)::&lt;lambda()&gt; &gt;::_M_invoke(const std::_Any_data &amp;) (__functor=...)
    at /usr/local/include/c++/5.4.0/functional:1871
#28 0x000055555708f4b2 in operator() (this=0x7ffff7fd94f0) at /usr/local/include/c++/5.4.0/functional:2267
#29 mongo::transport::ServiceExecutorSynchronous::schedule(std::function&lt;void ()&gt;, mongo::transport::ServiceExecutor::ScheduleFlags, mongo::transport::ServiceExecutorTaskName) (this=0x555558db4580, task=..., flags=flags@entry=mongo::transport::ServiceExecutor::kMayRecurse, taskName=taskName@entry=mongo::transport::kSSMProcessMessage)
    at src/mongo/transport/service_executor_synchronous.cpp:117
#30 0x0000555556131950 in mongo::ServiceStateMachine::_scheduleNextWithGuard (this=this@entry=0x55555cbd9d30, guard=..., 
    flags=flags@entry=mongo::transport::ServiceExecutor::kMayRecurse, taskName=taskName@entry=mongo::transport::kSSMProcessMessage, 
    ownershipModel=ownershipModel@entry=mongo::ServiceStateMachine::kOwned) at src/mongo/transport/service_state_machine.cpp:478
#31 0x0000555556134254 in mongo::ServiceStateMachine::_sourceCallback (this=this@entry=0x55555cbd9d30, status=...) at src/mongo/transport/service_state_machine.cpp:297
#32 0x0000555556134fd1 in mongo::ServiceStateMachine::_sourceMessage (this=this@entry=0x55555cbd9d30, guard=...) at src/mongo/transport/service_state_machine.cpp:254
#33 0x0000555556132b9d in mongo::ServiceStateMachine::_runNextInGuard (this=0x55555cbd9d30, guard=...) at src/mongo/transport/service_state_machine.cpp:428
#34 0x0000555556136f01 in operator() (__closure=0x55555cc6b0c0) at src/mongo/transport/service_state_machine.cpp:475
#35 std::_Function_handler&lt;void(), mongo::ServiceStateMachine::_scheduleNextWithGuard(mongo::ServiceStateMachine::ThreadGuard, mongo::transport::ServiceExecutor::ScheduleFlags, mongo::transport::ServiceExecutorTaskName, mongo::ServiceStateMachine::Ownership)::&lt;lambda()&gt; &gt;::_M_invoke(const std::_Any_data &amp;) (__functor=...)
    at /usr/local/include/c++/5.4.0/functional:1871
#36 0x000055555708fa15 in operator() (this=&lt;optimized out&gt;) at /usr/local/include/c++/5.4.0/functional:2267
#37 operator() (__closure=0x555558fa3480) at src/mongo/transport/service_executor_synchronous.cpp:134
#38 std::_Function_handler&lt;void(), mongo::transport::ServiceExecutorSynchronous::schedule(mongo::transport::ServiceExecutor::Task, mongo::transport::ServiceExecutor::ScheduleFlags, mongo::transport::ServiceExecutorTaskName)::&lt;lambda()&gt; &gt;::_M_invoke(const std::_Any_data &amp;) (__functor=...) at /usr/local/include/c++/5.4.0/functional:1871
#39 0x000055555763d664 in operator() (this=&lt;optimized out&gt;) at /usr/local/include/c++/5.4.0/functional:2267
#40 mongo::(anonymous namespace)::runFunc (ctx=0x55555cc4f4a0) at src/mongo/transport/service_entry_point_utils.cpp:57
#41 0x00007ffff6d0fe25 in start_thread () from /lib64/libpthread.so.0
#42 0x00007ffff6a39bad in clone () from /lib64/libc.so.6
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><h2 id="探索存储"><a href="#探索存储" class="header-anchor">#</a> 探索存储</h2> <ul><li>逻辑层与存储层的关联图<br> <img src="/Odyssey/assets/img/storage-tier-overview.72a92acf.png" alt="storage-tier-overview"></li></ul> <h2 id="gossip"><a href="#gossip" class="header-anchor">#</a> gossip</h2> <ul><li>fts: full text search</li> <li>ftdc: full-time diagnostic data capture</li> <li>wsm: working set memeber</li></ul> <h2 id="problem"><a href="#problem" class="header-anchor">#</a> problem</h2> <h2 id="gdb-配置"><a href="#gdb-配置" class="header-anchor">#</a> gdb 配置</h2> <ul><li><a href="./assets/mongodb/mongo.py">mongo-gdb-file</a></li> <li><a href="./assets/mongodb/stl-views.py">stl-gdb-file</a></li> <li><a href="./assets/mongodb/gdbinit">.gdbinit-file-info</a></li></ul> <h2 id="出现的问题"><a href="#出现的问题" class="header-anchor">#</a> 出现的问题</h2> <ul><li><a href="https://www.cnblogs.com/muahao/p/9078611.html" target="_blank" rel="noopener noreferrer">libstdc++的问题<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>pip install -U [jira, dnspython]各种升级</li> <li>pyyaml 重复问题，注释一个</li> <li>set scheduler-locking on|off|step，在gdb某个线程时候的调度禁止</li> <li>删除所有的test文件 find . -name &quot;<em>test</em>&quot; -type f |grep -v yml | xargs rm -rf</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/firekillice/Odyssey/edit/master/docs/reading/source/mongo.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: :</span> <span class="time">1/28/2021, 4:15:00 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Odyssey/reading/system/compile-principle.html" class="prev">
        编译器原理
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Odyssey/assets/js/app.736f8b8a.js" defer></script><script src="/Odyssey/assets/js/2.044c5f79.js" defer></script><script src="/Odyssey/assets/js/17.affaebd6.js" defer></script>
  </body>
</html>
