# gossip、2pc、raft、CAP信息的分布式旅行
* 大家好，我叫信息，我自从出生起就有两个特点，一个是可以传播，一个是可以复制，我的生存环境也有很多种，我可以生活在绳子中，我也可以生活在文字中，我也可以生活在绘画中，其实，我可以无处不在，有点像病毒和细菌。我在这个地球上无忧无虑的生活了很多很多年，知道地球上出现了一种东西叫计算机。这个家伙把我们信息可以说是一网打尽了，它把我们用电表示出来了，把我们关在内存中，把我们在电缆中传播，在光纤中传播，存储在一个叫磁盘的不见天日黑盒子中，只有我们遇见一个叫做显示器，才能看到光明，我是真喜欢显示器啊。
因为人类需要把我告诉很多人，就像以前曾经有人把我们放在纸上一样，计算机把我们塞进了电缆中传播，这个电缆需要用电，还要经过各种路口，我可能会遇到断电、交通阻塞、迷路等等，我有的走着走着就消失了。为了防止这些事情的发生，计算机世界设计了各种各样的方法与规则来保证我尽量能够准时到达对方。我听说的有tcp/ip、广播、arp、各种路由协议，这些都是针对我设计的，想想还有点骄傲呢。我被这样使用了一段时间之后呢，发现问题了如果那个叫磁盘的家伙坏了，我就在世界中消失了，这就不好了。为了可靠性或者说高可用，那就意味必须将我复制一份然后拷贝到别的地方，这个如果在一个计算机里就是RAID了，可是如果计算自身网络不同了，我的信息兄弟们也就没出路了，所以还得传播到别的计算机里面。可这样就涉及到一致性的问题，有了传播还会有网络异常的问题，所以高可用、复制、传播出问题这三者就不明不白的掺和在了一起，这个时候就有聪明的科学家证明了，C(Consistency)A(Availability)P(Partition tolerance)这个不可能三角，什么是C呢，C就是同一个数据同一个时刻不能读出两个不同的值。 什么是A呢，就是一直可以被访问，什么是P呢，就是节点之间通信出问题。从这个定义看出，只有涉及到数据的复制的问题才能应用CAP理论。比如下单了但是钱被多扣或者少扣，这个场景不涉及到数据的复制，应该是一个事务的问题，不是CAP针对的问题。
所以CAP定理决定了现实中只能有AP、CP、CA三者之间进行选择。如果不存在网络，比如单点的处理系统，那么就是一个CA系统。如果涉及到了网络传输，那就需要在CP和AP之间进行选择，有的时候为了可用性放弃了一致性，比如有些非敏感的数据，有的社会为了一致性放弃了可靠性，比如大多数的分布式数据库都是必须保证一致性的。而对于AP系统也不是完全不处理一致性，而是要保证最终一致性，或者说这就是BA(Basically Available)S(Soft-state)E(Eventually Consistent)理论要解决的问题。

但是即使这样其实要想让我们被安全并且准确的传达也挺难的，比如我举个栗子，张三、李四、王五、赵六四兄弟一块做生意，但是他们谁都不看到谁，只能通过网络联系，我们先假设这四个人都是可靠的即对所有的信息都能完好无损的复制和传播，避免"村东头老王感冒了"传到村西头就成了"老王被绿了"(这就是一个所谓的拜占庭问题了，这种情形就会变得更加复杂我们暂且不讲了)。他们四个最简单的联系方式就是互相打电话了，这就是信息的单播；如果他们四个语音会议，这就是信息的广播了。 如果张三告诉了李四和王五，王五又告诉了赵六，那这就有点gossip了，所以gossip就是我们信息的一个兄弟在多个节点之间被准确的传播直到所有节点都被告知了，这也就是最终一致性了（P2P下载用的就是这个协议）。但是这种方式有点问题，如果这时候有Jack和Jim同时分别问张三和李四"你们今年挣了多少钱啊"，这个时候张三说400万，李四说600万，那Jack和Jim就可能觉得他们四兄弟有问题啊。 那怎么保证了无论何时Jack和Jim都能从四兄弟那里得到一致的信息呢。请召唤Raft协议，Raft协议要求有一个leader，还有一些follower，那比如四兄弟中（正常情况下Raft需要奇数个节点此处4人只是举例）张三是轮值CEO，他那里能率先知道所有最新的信息，然后再告诉其他三兄弟。但是张三给兄弟们讲，我们得遵守一些协议，所有事情要么我们都知道，要么我们都不知道。不能有的知道有的人不知道，我们在信息上是平等的。这样以来，他们四兄弟对外表现的就像一个人似的达成了某种统一。但是他们四个合伙做生意，总有需要一起做事的时候吧，比如有一天需要李四投资10w，王五注资10w来提高公司的账面资金，而他们之间只能通过网络联系，张三作为CEO如何确认他们两个都完成了然后对外宣布公司账面资金增加了20w呢？这个时候就需要2PC了，张三先对李四说，你准备10w，李四说准备好了，然后对王五说准备10w，王五说准备好了；张三知道他俩都准备好了后就对他俩说可以达到公司账户了，然后他俩就执行了，张三就对外发布说公司资金又多了啊。所以，看到这里明白了，2PC是针对有亲戚的信息兄弟（据说被人类成为事务）协同处理的，而raft则是针对我们信息的复制传播的。如果你看到这里还不明白我的意思的话，建议去隔壁看一下各个协议的实现细节吧，据说有很多。



有一天，我听到他们讨论分布式的事情，我是第一次听到这个事情，还挺好奇的。经过了九九六十四天之后，我听明白了，分布式就是那个叫计算机的活一个人干不完了，需要把任务分解后外包出去让别的计算机干。