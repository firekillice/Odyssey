<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>中断 | Hungry&amp;Eating</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="">
    <link rel="preload" href="/Odyssey/assets/css/0.styles.35a5e89f.css" as="style"><link rel="preload" href="/Odyssey/assets/js/app.736f8b8a.js" as="script"><link rel="preload" href="/Odyssey/assets/js/2.044c5f79.js" as="script"><link rel="preload" href="/Odyssey/assets/js/9.14a4b067.js" as="script"><link rel="prefetch" href="/Odyssey/assets/js/10.d41f3c7c.js"><link rel="prefetch" href="/Odyssey/assets/js/100.69898e8b.js"><link rel="prefetch" href="/Odyssey/assets/js/101.522618eb.js"><link rel="prefetch" href="/Odyssey/assets/js/102.5c58fea2.js"><link rel="prefetch" href="/Odyssey/assets/js/103.231e7290.js"><link rel="prefetch" href="/Odyssey/assets/js/104.014c3e51.js"><link rel="prefetch" href="/Odyssey/assets/js/105.5dec6e62.js"><link rel="prefetch" href="/Odyssey/assets/js/106.4e733698.js"><link rel="prefetch" href="/Odyssey/assets/js/107.60d5b072.js"><link rel="prefetch" href="/Odyssey/assets/js/108.9e6ad3f3.js"><link rel="prefetch" href="/Odyssey/assets/js/109.6baf415c.js"><link rel="prefetch" href="/Odyssey/assets/js/11.f2fee731.js"><link rel="prefetch" href="/Odyssey/assets/js/110.8fd1b2b3.js"><link rel="prefetch" href="/Odyssey/assets/js/111.4c25b1c5.js"><link rel="prefetch" href="/Odyssey/assets/js/112.ad336252.js"><link rel="prefetch" href="/Odyssey/assets/js/12.8a1ba8cb.js"><link rel="prefetch" href="/Odyssey/assets/js/13.2b7a02b1.js"><link rel="prefetch" href="/Odyssey/assets/js/14.dd904d52.js"><link rel="prefetch" href="/Odyssey/assets/js/15.34ceb40c.js"><link rel="prefetch" href="/Odyssey/assets/js/16.f321f7c9.js"><link rel="prefetch" href="/Odyssey/assets/js/17.affaebd6.js"><link rel="prefetch" href="/Odyssey/assets/js/18.5503f8b8.js"><link rel="prefetch" href="/Odyssey/assets/js/19.ed696375.js"><link rel="prefetch" href="/Odyssey/assets/js/20.be5f35fa.js"><link rel="prefetch" href="/Odyssey/assets/js/21.a5102283.js"><link rel="prefetch" href="/Odyssey/assets/js/22.82e0c238.js"><link rel="prefetch" href="/Odyssey/assets/js/23.2b17eea6.js"><link rel="prefetch" href="/Odyssey/assets/js/24.4508b587.js"><link rel="prefetch" href="/Odyssey/assets/js/25.86c8fb1f.js"><link rel="prefetch" href="/Odyssey/assets/js/26.105a4513.js"><link rel="prefetch" href="/Odyssey/assets/js/27.dc65fe01.js"><link rel="prefetch" href="/Odyssey/assets/js/28.7ee124c8.js"><link rel="prefetch" href="/Odyssey/assets/js/29.50d7e58a.js"><link rel="prefetch" href="/Odyssey/assets/js/3.76432ce0.js"><link rel="prefetch" href="/Odyssey/assets/js/30.002de48f.js"><link rel="prefetch" href="/Odyssey/assets/js/31.eb86b12f.js"><link rel="prefetch" href="/Odyssey/assets/js/32.2d83f202.js"><link rel="prefetch" href="/Odyssey/assets/js/33.879c8d31.js"><link rel="prefetch" href="/Odyssey/assets/js/34.1891a7db.js"><link rel="prefetch" href="/Odyssey/assets/js/35.2425bacc.js"><link rel="prefetch" href="/Odyssey/assets/js/36.51acb1aa.js"><link rel="prefetch" href="/Odyssey/assets/js/37.37bff99e.js"><link rel="prefetch" href="/Odyssey/assets/js/38.3f8720f7.js"><link rel="prefetch" href="/Odyssey/assets/js/39.76e0dc46.js"><link rel="prefetch" href="/Odyssey/assets/js/4.ad59de73.js"><link rel="prefetch" href="/Odyssey/assets/js/40.7ec36cd5.js"><link rel="prefetch" href="/Odyssey/assets/js/41.069851a8.js"><link rel="prefetch" href="/Odyssey/assets/js/42.7c97bffd.js"><link rel="prefetch" href="/Odyssey/assets/js/43.f04444ab.js"><link rel="prefetch" href="/Odyssey/assets/js/44.e4ed2b3f.js"><link rel="prefetch" href="/Odyssey/assets/js/45.6a2e2f62.js"><link rel="prefetch" href="/Odyssey/assets/js/46.80a2cf59.js"><link rel="prefetch" href="/Odyssey/assets/js/47.06744c06.js"><link rel="prefetch" href="/Odyssey/assets/js/48.7e16dc16.js"><link rel="prefetch" href="/Odyssey/assets/js/49.e88ae0cf.js"><link rel="prefetch" href="/Odyssey/assets/js/5.3986ff40.js"><link rel="prefetch" href="/Odyssey/assets/js/50.8f65c57c.js"><link rel="prefetch" href="/Odyssey/assets/js/51.8bb5804d.js"><link rel="prefetch" href="/Odyssey/assets/js/52.110679f9.js"><link rel="prefetch" href="/Odyssey/assets/js/53.ed3457ae.js"><link rel="prefetch" href="/Odyssey/assets/js/54.eff49780.js"><link rel="prefetch" href="/Odyssey/assets/js/55.77bfb65f.js"><link rel="prefetch" href="/Odyssey/assets/js/56.f9d2ff1e.js"><link rel="prefetch" href="/Odyssey/assets/js/57.9463926d.js"><link rel="prefetch" href="/Odyssey/assets/js/58.73a73232.js"><link rel="prefetch" href="/Odyssey/assets/js/59.3a3e853e.js"><link rel="prefetch" href="/Odyssey/assets/js/6.348464c7.js"><link rel="prefetch" href="/Odyssey/assets/js/60.9c66dd2d.js"><link rel="prefetch" href="/Odyssey/assets/js/61.ee0b9a8b.js"><link rel="prefetch" href="/Odyssey/assets/js/62.76d18fcb.js"><link rel="prefetch" href="/Odyssey/assets/js/63.dd25e434.js"><link rel="prefetch" href="/Odyssey/assets/js/64.f2cd0b44.js"><link rel="prefetch" href="/Odyssey/assets/js/65.47204a7c.js"><link rel="prefetch" href="/Odyssey/assets/js/66.605a4a82.js"><link rel="prefetch" href="/Odyssey/assets/js/67.34132ce0.js"><link rel="prefetch" href="/Odyssey/assets/js/68.f3bcfc00.js"><link rel="prefetch" href="/Odyssey/assets/js/69.3640c28b.js"><link rel="prefetch" href="/Odyssey/assets/js/7.869b5935.js"><link rel="prefetch" href="/Odyssey/assets/js/70.e2a8446b.js"><link rel="prefetch" href="/Odyssey/assets/js/71.c9f6b4d3.js"><link rel="prefetch" href="/Odyssey/assets/js/72.201bfcc2.js"><link rel="prefetch" href="/Odyssey/assets/js/73.7e8e995e.js"><link rel="prefetch" href="/Odyssey/assets/js/74.ea2a2167.js"><link rel="prefetch" href="/Odyssey/assets/js/75.7009c10e.js"><link rel="prefetch" href="/Odyssey/assets/js/76.48b75434.js"><link rel="prefetch" href="/Odyssey/assets/js/77.fa8e9cd3.js"><link rel="prefetch" href="/Odyssey/assets/js/78.5cb5a672.js"><link rel="prefetch" href="/Odyssey/assets/js/79.5adebe29.js"><link rel="prefetch" href="/Odyssey/assets/js/8.a0861537.js"><link rel="prefetch" href="/Odyssey/assets/js/80.fcb9624a.js"><link rel="prefetch" href="/Odyssey/assets/js/81.42c49b3a.js"><link rel="prefetch" href="/Odyssey/assets/js/82.477309e7.js"><link rel="prefetch" href="/Odyssey/assets/js/83.38767490.js"><link rel="prefetch" href="/Odyssey/assets/js/84.c80b8f93.js"><link rel="prefetch" href="/Odyssey/assets/js/85.b1ca1383.js"><link rel="prefetch" href="/Odyssey/assets/js/86.0bb83cf2.js"><link rel="prefetch" href="/Odyssey/assets/js/87.632e928e.js"><link rel="prefetch" href="/Odyssey/assets/js/88.924c9285.js"><link rel="prefetch" href="/Odyssey/assets/js/89.34d3c3ff.js"><link rel="prefetch" href="/Odyssey/assets/js/90.2e394c85.js"><link rel="prefetch" href="/Odyssey/assets/js/91.b604e092.js"><link rel="prefetch" href="/Odyssey/assets/js/92.94b169d8.js"><link rel="prefetch" href="/Odyssey/assets/js/93.0e2742ef.js"><link rel="prefetch" href="/Odyssey/assets/js/94.449bcab7.js"><link rel="prefetch" href="/Odyssey/assets/js/95.250c02be.js"><link rel="prefetch" href="/Odyssey/assets/js/96.eee6aed4.js"><link rel="prefetch" href="/Odyssey/assets/js/97.3198ad58.js"><link rel="prefetch" href="/Odyssey/assets/js/98.1b0a34c9.js"><link rel="prefetch" href="/Odyssey/assets/js/99.9021c172.js">
    <link rel="stylesheet" href="/Odyssey/assets/css/0.styles.35a5e89f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Odyssey/" class="home-link router-link-active"><!----> <span class="site-name">Hungry&amp;Eating</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Odyssey/reading/" class="nav-link">
  阅读
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机综合" class="dropdown-title"><span class="title">学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机综合" class="mobile-dropdown-title"><span class="title">学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Odyssey/cache/" class="nav-link">
  缓存
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/code/" class="nav-link">
  coding
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/struct/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/db/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/storage/" class="nav-link">
  存储
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/os/" class="nav-link router-link-active">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/protocol/" class="nav-link">
  协议
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/network/" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/design/" class="nav-link">
  设计
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/web/" class="nav-link">
  www
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/insight/" class="nav-link">
  理解
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/unclassified/" class="nav-link">
  未分类
</a></li></ul></div></div> <a href="https://github.com/firekillice/Odyssey" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Odyssey/reading/" class="nav-link">
  阅读
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机综合" class="dropdown-title"><span class="title">学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机综合" class="mobile-dropdown-title"><span class="title">学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Odyssey/cache/" class="nav-link">
  缓存
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/code/" class="nav-link">
  coding
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/struct/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/db/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/storage/" class="nav-link">
  存储
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/os/" class="nav-link router-link-active">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/protocol/" class="nav-link">
  协议
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/network/" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/design/" class="nav-link">
  设计
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/web/" class="nav-link">
  www
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/insight/" class="nav-link">
  理解
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/unclassified/" class="nav-link">
  未分类
</a></li></ul></div></div> <a href="https://github.com/firekillice/Odyssey" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>操作系统</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Odyssey/os/linux.html" class="sidebar-link">LINUX</a></li><li><a href="/Odyssey/os/buffer.html" class="sidebar-link">缓冲</a></li><li><a href="/Odyssey/os/fs.html" class="sidebar-link">文件系统</a></li><li><a href="/Odyssey/os/mm.html" class="sidebar-link">内存管理</a></li><li><a href="/Odyssey/os/vm.html" class="sidebar-link">虚拟机</a></li><li><a href="/Odyssey/os/time.html" class="sidebar-link">时间</a></li><li><a href="/Odyssey/os/syscall.html" class="sidebar-link">系统调用</a></li><li><a href="/Odyssey/os/process.html" class="sidebar-link">process</a></li><li><a href="/Odyssey/os/interrupt.html" aria-current="page" class="active sidebar-link">中断</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Odyssey/os/interrupt.html#theory" class="sidebar-link">theory</a></li><li class="sidebar-sub-header"><a href="/Odyssey/os/interrupt.html#分类" class="sidebar-link">分类</a></li><li class="sidebar-sub-header"><a href="/Odyssey/os/interrupt.html#isr-interrupt-service-routine-实现" class="sidebar-link">ISR(Interrupt Service Routine)实现</a></li><li class="sidebar-sub-header"><a href="/Odyssey/os/interrupt.html#上下文-context" class="sidebar-link">上下文(context)</a></li><li class="sidebar-sub-header"><a href="/Odyssey/os/interrupt.html#deferred-work" class="sidebar-link">deferred work</a></li><li class="sidebar-sub-header"><a href="/Odyssey/os/interrupt.html#查看中断在cpu上的执行情况" class="sidebar-link">查看中断在cpu上的执行情况</a></li><li class="sidebar-sub-header"><a href="/Odyssey/os/interrupt.html#中断的返回" class="sidebar-link">中断的返回</a></li><li class="sidebar-sub-header"><a href="/Odyssey/os/interrupt.html#signal" class="sidebar-link">signal</a></li><li class="sidebar-sub-header"><a href="/Odyssey/os/interrupt.html#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/Odyssey/os/concurrency.html" class="sidebar-link">并发问题</a></li><li><a href="/Odyssey/os/deadlock.html" class="sidebar-link">deadlock</a></li><li><a href="/Odyssey/os/io.html" class="sidebar-link">IO</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="中断"><a href="#中断" class="header-anchor">#</a> 中断</h1> <ul><li>中断是对cpu的劫持</li> <li>可编程中断的意思是，可以软硬结合</li> <li>Interrupts and exceptions are events that indicate that a condition exists somewhere in the system, the processor, or within the currently executing program or task that requires the attention of a processor.</li> <li>System hardware uses interrupts to handle events external to the processor, such as requests to service peripheral devices. Software can also generate interrupts by executing the INT n instruction.</li> <li>系统调用原来也是中断进入到内核，现在也支持，不过不推荐了</li> <li>可以认为，除了正常的进程调度，若有其他事件发生，都是通过中断切入到内核的</li></ul> <h2 id="theory"><a href="#theory" class="header-anchor">#</a> theory</h2> <ul><li><p>基于event和time的cpu处理模型，time driven &amp; event driven</p> <p><img src="/Odyssey/assets/img/20200930211117.fca6d754.png" alt="event"></p> <hr> <p><img src="/Odyssey/assets/img/20200930211156.317ec684.png" alt="event-type"></p></li> <li><p>signal event interrupt 三种说法</p></li></ul> <h2 id="分类"><a href="#分类" class="header-anchor">#</a> 分类</h2> <ul><li><p>同步（synchronous）中断和异步（asynchronous）中断</p> <p>同步中断是当指令执行时由 CPU 控制单元产生，之所以称为同步，是因为只有在一条指令执行完毕后 CPU 才会发出中断，而不是发生在代码指令执行期间，比如系统调用。</p> <p>异步中断是指由其他硬件设备依照 CPU 时钟信号随机产生，即意味着中断能够在指令之间发生，例如键盘中断。</p></li> <li><p>根据Intel 官方资料, 同步中断称为异常（exception），异步中断被称为中断（interrupt）</p></li> <li><p>中断可分为可屏蔽中断（Maskable interrupt）和非屏蔽中断（Nomaskable interrupt）</p></li> <li><p>异常可分为故障（fault）、陷阱（trap）、终止（abort）三类 <img src="/Odyssey/assets/img/20201012154511.d2597754.png" alt="三者的区别"></p></li></ul> <h2 id="isr-interrupt-service-routine-实现"><a href="#isr-interrupt-service-routine-实现" class="header-anchor">#</a> ISR(Interrupt Service Routine)实现</h2> <ul><li>An interrupt service routine (ISR) is a software routine that hardware invokes in response to an interrupt.</li></ul> <h4 id="irq-interrupt-request"><a href="#irq-interrupt-request" class="header-anchor">#</a> IRQ (interrupt request )</h4> <ul><li>an interrupt request (or IRQ) is a <strong>hardware signal</strong> sent to the processor that temporarily stops a running program and allows a special program, an interrupt handler, to run instead.</li></ul> <h4 id="idt-interrupt-descriptor-table"><a href="#idt-interrupt-descriptor-table" class="header-anchor">#</a> IDT (Interrupt Descriptor Table)</h4> <ul><li>idt vector definition，使用该vector中的值来索引IDT中的数据
<img src="/Odyssey/assets/img/20201012153132.a09d4058.png" alt="idt vector，来自(https://pdos.csail.mit.edu/6.828/2003/readings/intelv3.pdf)"></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>1. The vectors in the range 0 through 31 are reserved by the IA-32 architecture for architecture-defined exceptions and interrupts. Not all of the vectors in this range have a currently defined function. The unassigned vectors in this range are reserved for future uses. Do not use the reserved vectors.
2. The vectors in the range 32 to 255 are designated as user-defined interrupts and are not reserved by the IA-32 architecture. These interrupts are generally assigned to external I/O devices to enable those devices to send interrupts to the processor through one of the external hardware interrupt mechanisms.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li><p>一个系统表，它与每一个中断或异常向量相联系，每一个向量在表中存放的是相应的中断或异常处理程序的入口地址。内核在允许中断发生前，也就是在系统初始化时，必须把 IDT 表的初始化地址装载到 idtr 寄存器中，初始化表中的每一项。</p> <p><img src="/Odyssey/assets/img/figure_interruptdispatching_1.8e7878b4.png" alt="idtr"></p> <hr> <p><img src="/Odyssey/assets/img/UDT-03282013.fc35ad43.jpg" alt="idtr&amp;gdt"></p></li> <li><p>gdt是查看到segment对应的虚拟地址的起始地址</p></li> <li><p>idtr在gdb下无法查看，因为其只有在ring0级别(内核态)才可以看到，而gdb工作在ring3级别(用户态)(intel设计了4层的ring)</p></li></ul> <h4 id="关联的硬件"><a href="#关联的硬件" class="header-anchor">#</a> 关联的硬件</h4> <ul><li>PIC(Programmable Interrupt Controller) &amp; APIC(Advanced Programmable Interrupt Controller)
<img src="/Odyssey/assets/img/20200930211027.9d2cb32d.png" alt="pic"></li> <li>local apic，local的参照物为cpu</li></ul> <h4 id="分为两个阶段"><a href="#分为两个阶段" class="header-anchor">#</a> 分为两个阶段</h4> <ul><li>top half 和 [bottom half](#deferred work )</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>上半部(top halves)：不得不做的工作放在上半部，也即中断处理程序中，例如告知外设接收到中断、将数据从外设中拷贝到内存
下半部(bottom halves)：不紧急的工作延后完成，如处理上半部中从外设拷贝来的数据
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="/Odyssey/assets/img/interrupt_delay_top_bottom.bfdaf305.svg" alt="两段"></p> <h2 id="上下文-context"><a href="#上下文-context" class="header-anchor">#</a> 上下文(context)</h2> <h4 id="中断上下文"><a href="#中断上下文" class="header-anchor">#</a> 中断上下文</h4> <ul><li>每个中断对应一个中断处理函数，当中断处理函数被调用时，内核处于中断上下文(interrupt context)。</li> <li>不同于进程上下文(process context)，中断处理过程中不能发生阻塞、休眠，即不进行进程调度，因为要快速处理中断的消息以让外设继续工作，另外一个设计上的原因是中断没有独立的堆栈切换机制</li> <li>中断上下文不执行不属于任何的进程，也可以解释为什么不参与调度</li></ul> <h4 id="进程上下文"><a href="#进程上下文" class="header-anchor">#</a> 进程上下文</h4> <ul><li>分为用户态(ring3)和内核态(ring0)，两个堆栈可以切换</li></ul> <h2 id="deferred-work"><a href="#deferred-work" class="header-anchor">#</a> deferred work</h2> <ul><li><p>三种延迟处理机制，softirq、tasklet、workqueue, tasklets基于softirq</p></li> <li><p>因为硬中断是不可打断的，但是针对网络数据包这种处理阶段比较长的情况，需要只让cpu处理最紧要的事情，其他的事情稍后处理，这就是soft interrup产生的原因</p></li> <li><p>软中断是软件触发的中断，使用raise_softirq接口进行触发，常见的两个触发场景，中断处理后和Bottom-half Enable后</p></li> <li><p>softirq vs tasklet, tasklet提供一种动态的能力</p></li></ul> <table><thead><tr><th>比对的特点</th> <th>softirq</th> <th>tasklet</th></tr></thead> <tbody><tr><td>并行能力</td> <td>同一个softirq处理函数能够同时运行在多个CPU上，因此同步是必要的</td> <td>同一个tasklet处理函数不能同时运行在多个CPU上，因此同步是不必要的</td></tr> <tr><td>中断处理函数的注册方法</td> <td>只能在编译链接时静态注册</td> <td>不仅能静态注册而且还能动态注册</td></tr> <tr><td>优先级</td> <td>每个softirq都具有一个执行优先级 ，如果在同一时刻有多个待处理的softirq，那么最高优先级的softirq会被先处理</td> <td>tasklet只有两种优先级：高优先级「high priority」和正常优先级「normal priority」</td></tr> <tr><td>使用场景</td> <td>仅在执行非常频繁且需要并行处理的场景下才使用</td> <td>在softirq不能胜任和需要串行化处理的情况下使用，同时在设备驱动中也是可以使用的</td></tr></tbody></table> <ul><li>softirq类型</li></ul> <table><thead><tr><th>0</th> <th>HI_SOFTIRQ</th> <th>最高优先级，用于处理TASKLET_HI</th></tr></thead> <tbody><tr><td>1</td> <td>TIMER_SOFTIRQ</td> <td>用于处理每个CPU的计时器中断「timer interrupt」</td></tr> <tr><td>2</td> <td>NET_TX_SOFTIRQ</td> <td>用于处理网络设备的报文发送中断</td></tr> <tr><td>3</td> <td>NET_RX_SOFTIRQ</td> <td>用于处理网络设备的报文接收中断</td></tr> <tr><td>4</td> <td>BLOCK_SOFTIRQ</td> <td>用于处理块设备「block device」的中断</td></tr> <tr><td>5</td> <td>IRQ_POLL_SOFTIRQ</td> <td>用于执行IOPOLL的回调函数「handler」</td></tr> <tr><td>6</td> <td>TASKLET_SOFTIRQ</td> <td>用于处理tasklet</td></tr> <tr><td>7</td> <td>SCHED_SOFTIRQ</td> <td>用于处理调度「schedule」相关的IPI和执行CFS的负载均衡例程</td></tr> <tr><td>8</td> <td>HRTIMER_SOFTIRQ</td> <td>目前没有使用，还保留也只是为了占用一个数字</td></tr> <tr><td>9</td> <td>RCU_SOFTIRQ</td> <td>用于处理RCU中断，最低优先级，因此每次都在最后处理</td></tr></tbody></table> <div class="language- line-numbers-mode"><pre class="language-text"><code>查看处理数据
&gt; cat /proc/softirqs 
                    CPU0       CPU1       CPU2       CPU3       CPU4       CPU5       CPU6       CPU7       
          HI:          1          1          0          0          2          0          0          0
       TIMER:  241846312 1671934570  273007834 1726792651  201341114 1644008532  182342249 1644896462
      NET_TX:        138         45        131         71        218         65        122         61
      NET_RX: 3947735107 3149190903 4033712025 3195028836 3890319448 3119133143 4103968256 3402515225
       BLOCK:          0          0          0          0          0          0          0          0
BLOCK_IOPOLL:          0          0          0          0          0          0          0          0
     TASKLET:        201         29        251         35        188         30        242         35
       SCHED: 2180338424 3965089846 2186628968 3875527819 2064144853 3883505174 2055440282 3857640088
     HRTIMER:          0          0          0          0          0          0          0          0
         RCU: 1458914748 1905483384 1524745564 1923565274 1462350009 1903291217 1446345827 1896192088

查看执行进程
&gt; ps aux |grep ksoftirqd
root          3  0.0  0.0      0     0 ?        S    Sep01   0:22 [ksoftirqd/0]
root         14  0.0  0.0      0     0 ?        S    Sep01   2:13 [ksoftirqd/1]
sandsto+ 111348  0.0  0.0 112816   972 pts/6    S+   21:57   0:00 grep --color=auto ksoftirqd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><ul><li>softirq implement</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>/* 支持的软中断类型，可以认为是软中断号， 其中从上到下优先级递减 */
enum
{
	HI_SOFTIRQ=0,       /* 最高优先级软中断 */
	TIMER_SOFTIRQ,      /* Timer定时器软中断 */
	NET_TX_SOFTIRQ,     /* 发送网络数据包软中断 */
	NET_RX_SOFTIRQ,     /* 接收网络数据包软中断 */
	BLOCK_SOFTIRQ,      /* 块设备软中断 */
	IRQ_POLL_SOFTIRQ,   /* 块设备软中断 */
	TASKLET_SOFTIRQ,    /* tasklet软中断 */
	SCHED_SOFTIRQ,      /* 进程调度及负载均衡的软中断 */
	HRTIMER_SOFTIRQ, /* Unused, but kept as tools rely on thenumbering. Sigh! */
	RCU_SOFTIRQ,    /* Preferable RCU should always be the last softirq， RCU相关的软中断 */

	NR_SOFTIRQS
};

/* 软件中断描述符，只包含一个handler函数指针 */
struct softirq_action {
	void	(*action)(struct softirq_action *);
};
/* 软中断描述符表，实际上就是一个全局的数组 */
static struct softirq_action softirq_vec[NR_SOFTIRQS] __cacheline_aligned_in_smp;

/* CPU软中断状态描述，当某个软中断触发时，__softirq_pending会置位对应的bit */
typedef struct {
	unsigned int __softirq_pending;
	unsigned int ipi_irqs[NR_IPI];
} ____cacheline_aligned irq_cpustat_t;
/* 每个CPU都会维护一个状态信息结构 */
irq_cpustat_t irq_stat[NR_CPUS] ____cacheline_aligned;

/* 内核为每个CPU都创建了一个软中断处理内核线程 */
DEFINE_PER_CPU(struct task_struct *, ksoftirqd);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><hr> <p><img src="/Odyssey/assets/img/1771657-20200614143709476-1385185613.125b045a.png" alt="softirq-struct"></p> <ul><li>tasklet的实现图解</li></ul> <p><img src="/Odyssey/assets/img/1771657-20200614144637377-134840993.9c3c34ec.png" alt="tasklet frame"></p> <hr> <p><img src="/Odyssey/assets/img/1771657-20200614144659971-1767445003.cac77544.png" alt="tasklet process">
注意tasklet_action是和softirq的关联点</p> <h2 id="查看中断在cpu上的执行情况"><a href="#查看中断在cpu上的执行情况" class="header-anchor">#</a> 查看中断在cpu上的执行情况</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code> cat /proc/interrupts 
            CPU0       CPU1       
   0:         90          0   IO-APIC-edge      timer
   1:         12          0   IO-APIC-edge      i8042
   6:         17          0   IO-APIC-edge      floppy
   8:          1          0   IO-APIC-edge      rtc0
   9:          0          0   IO-APIC-fasteoi   acpi
  12:         58          0   IO-APIC-edge      i8042
  14:          0          0   IO-APIC-edge      ata_piix
  15:    2502351          0   IO-APIC-edge      ata_piix
  16:          2          0   IO-APIC-fasteoi   vmwgfx, snd_ens1371
  17:    2997408          0   IO-APIC-fasteoi   ehci_hcd:usb1, ioc0
  18:         71          0   IO-APIC-fasteoi   uhci_hcd:usb2
  19:        145  111310754   IO-APIC-fasteoi   ens33
  24:          0          0   PCI-MSI-edge      PCIe PME, pciehp
  25:          0          0   PCI-MSI-edge      PCIe PME, pciehp
  26:          0          0   PCI-MSI-edge      PCIe PME, pciehp
  ...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="中断的返回"><a href="#中断的返回" class="header-anchor">#</a> 中断的返回</h2> <ul><li>When the processor performs a call to the exception- or interrupt-handler procedure, it saves the current states of the EFLAGS register, CS register, and EIP register on the stack. (The CS and EIP registers provide a return instruction pointer for the handler.) If an exception causes an error code to be saved, it is pushed on the stack after the EIP value.</li> <li>If the handler procedure is going to be executed at the same privilege level as the interrupted procedure, the handler uses the current stack.</li> <li>If the handler procedure is going to be executed at a numerically lower privilege level, a stack switch occurs. When a stack switch occurs, a stack pointer for the stack to be returned to is also saved on the stack. (The SS and ESP registers provide a return stack pointer for the handler.) The segment selector and stack pointer for the stack to be used by the handler is obtained from the TSS for the currently executing task. The processor copies the EFLAGS, SS, ESP, CS, EIP, and error code information from the interrupted procedure’s stack to the handler’s stack.</li> <li>If a stack switch occurred when calling the handler procedure, the IRET instruction switches back to the interrupted procedure’s stack on the return.
<img src="/Odyssey/assets/img/20201012165043.209d6612.png" alt="stack of interrupt"></li></ul> <p><img src="/Odyssey/assets/img/20201012165449.99c61e4f.png" alt="return"></p> <h2 id="signal"><a href="#signal" class="header-anchor">#</a> signal</h2> <ul><li>就是计算机内部通信的基本机制，不管是进程间还是硬件与cpu之间</li></ul> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <p><a href="http://arthurchiao.art/blog/system-call-definitive-guide-zh/" target="_blank" rel="noopener noreferrer">Linux 系统调用权威指南<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://pdos.csail.mit.edu/6.828/2003/readings/intelv3.pdf" target="_blank" rel="noopener noreferrer">IA-32 Intel开发者手册<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://pdos.csail.mit.edu/6.828/2004/lec/lec8-slides.pdf" target="_blank" rel="noopener noreferrer">Interrupt and Exception Handling on the x86<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/firekillice/Odyssey/edit/master/docs/os/interrupt.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: :</span> <span class="time">10/12/2020, 5:03:21 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Odyssey/os/process.html" class="prev">
        process
      </a></span> <span class="next"><a href="/Odyssey/os/concurrency.html">
        并发问题
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Odyssey/assets/js/app.736f8b8a.js" defer></script><script src="/Odyssey/assets/js/2.044c5f79.js" defer></script><script src="/Odyssey/assets/js/9.14a4b067.js" defer></script>
  </body>
</html>
