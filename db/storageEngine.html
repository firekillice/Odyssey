<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>存储引擎 | Hungry&amp;Eating</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="">
    <link rel="preload" href="/Odyssey/assets/css/0.styles.35a5e89f.css" as="style"><link rel="preload" href="/Odyssey/assets/js/app.736f8b8a.js" as="script"><link rel="preload" href="/Odyssey/assets/js/2.044c5f79.js" as="script"><link rel="preload" href="/Odyssey/assets/js/14.dd904d52.js" as="script"><link rel="prefetch" href="/Odyssey/assets/js/10.d41f3c7c.js"><link rel="prefetch" href="/Odyssey/assets/js/100.69898e8b.js"><link rel="prefetch" href="/Odyssey/assets/js/101.522618eb.js"><link rel="prefetch" href="/Odyssey/assets/js/102.5c58fea2.js"><link rel="prefetch" href="/Odyssey/assets/js/103.231e7290.js"><link rel="prefetch" href="/Odyssey/assets/js/104.014c3e51.js"><link rel="prefetch" href="/Odyssey/assets/js/105.5dec6e62.js"><link rel="prefetch" href="/Odyssey/assets/js/106.4e733698.js"><link rel="prefetch" href="/Odyssey/assets/js/107.60d5b072.js"><link rel="prefetch" href="/Odyssey/assets/js/108.9e6ad3f3.js"><link rel="prefetch" href="/Odyssey/assets/js/109.6baf415c.js"><link rel="prefetch" href="/Odyssey/assets/js/11.f2fee731.js"><link rel="prefetch" href="/Odyssey/assets/js/110.8fd1b2b3.js"><link rel="prefetch" href="/Odyssey/assets/js/111.4c25b1c5.js"><link rel="prefetch" href="/Odyssey/assets/js/112.ad336252.js"><link rel="prefetch" href="/Odyssey/assets/js/12.8a1ba8cb.js"><link rel="prefetch" href="/Odyssey/assets/js/13.2b7a02b1.js"><link rel="prefetch" href="/Odyssey/assets/js/15.34ceb40c.js"><link rel="prefetch" href="/Odyssey/assets/js/16.f321f7c9.js"><link rel="prefetch" href="/Odyssey/assets/js/17.affaebd6.js"><link rel="prefetch" href="/Odyssey/assets/js/18.5503f8b8.js"><link rel="prefetch" href="/Odyssey/assets/js/19.ed696375.js"><link rel="prefetch" href="/Odyssey/assets/js/20.be5f35fa.js"><link rel="prefetch" href="/Odyssey/assets/js/21.a5102283.js"><link rel="prefetch" href="/Odyssey/assets/js/22.82e0c238.js"><link rel="prefetch" href="/Odyssey/assets/js/23.2b17eea6.js"><link rel="prefetch" href="/Odyssey/assets/js/24.4508b587.js"><link rel="prefetch" href="/Odyssey/assets/js/25.86c8fb1f.js"><link rel="prefetch" href="/Odyssey/assets/js/26.105a4513.js"><link rel="prefetch" href="/Odyssey/assets/js/27.dc65fe01.js"><link rel="prefetch" href="/Odyssey/assets/js/28.7ee124c8.js"><link rel="prefetch" href="/Odyssey/assets/js/29.50d7e58a.js"><link rel="prefetch" href="/Odyssey/assets/js/3.76432ce0.js"><link rel="prefetch" href="/Odyssey/assets/js/30.002de48f.js"><link rel="prefetch" href="/Odyssey/assets/js/31.eb86b12f.js"><link rel="prefetch" href="/Odyssey/assets/js/32.2d83f202.js"><link rel="prefetch" href="/Odyssey/assets/js/33.879c8d31.js"><link rel="prefetch" href="/Odyssey/assets/js/34.1891a7db.js"><link rel="prefetch" href="/Odyssey/assets/js/35.2425bacc.js"><link rel="prefetch" href="/Odyssey/assets/js/36.51acb1aa.js"><link rel="prefetch" href="/Odyssey/assets/js/37.37bff99e.js"><link rel="prefetch" href="/Odyssey/assets/js/38.3f8720f7.js"><link rel="prefetch" href="/Odyssey/assets/js/39.76e0dc46.js"><link rel="prefetch" href="/Odyssey/assets/js/4.ad59de73.js"><link rel="prefetch" href="/Odyssey/assets/js/40.7ec36cd5.js"><link rel="prefetch" href="/Odyssey/assets/js/41.069851a8.js"><link rel="prefetch" href="/Odyssey/assets/js/42.7c97bffd.js"><link rel="prefetch" href="/Odyssey/assets/js/43.f04444ab.js"><link rel="prefetch" href="/Odyssey/assets/js/44.e4ed2b3f.js"><link rel="prefetch" href="/Odyssey/assets/js/45.6a2e2f62.js"><link rel="prefetch" href="/Odyssey/assets/js/46.80a2cf59.js"><link rel="prefetch" href="/Odyssey/assets/js/47.06744c06.js"><link rel="prefetch" href="/Odyssey/assets/js/48.7e16dc16.js"><link rel="prefetch" href="/Odyssey/assets/js/49.e88ae0cf.js"><link rel="prefetch" href="/Odyssey/assets/js/5.3986ff40.js"><link rel="prefetch" href="/Odyssey/assets/js/50.8f65c57c.js"><link rel="prefetch" href="/Odyssey/assets/js/51.8bb5804d.js"><link rel="prefetch" href="/Odyssey/assets/js/52.110679f9.js"><link rel="prefetch" href="/Odyssey/assets/js/53.ed3457ae.js"><link rel="prefetch" href="/Odyssey/assets/js/54.eff49780.js"><link rel="prefetch" href="/Odyssey/assets/js/55.77bfb65f.js"><link rel="prefetch" href="/Odyssey/assets/js/56.f9d2ff1e.js"><link rel="prefetch" href="/Odyssey/assets/js/57.9463926d.js"><link rel="prefetch" href="/Odyssey/assets/js/58.73a73232.js"><link rel="prefetch" href="/Odyssey/assets/js/59.3a3e853e.js"><link rel="prefetch" href="/Odyssey/assets/js/6.348464c7.js"><link rel="prefetch" href="/Odyssey/assets/js/60.9c66dd2d.js"><link rel="prefetch" href="/Odyssey/assets/js/61.ee0b9a8b.js"><link rel="prefetch" href="/Odyssey/assets/js/62.76d18fcb.js"><link rel="prefetch" href="/Odyssey/assets/js/63.dd25e434.js"><link rel="prefetch" href="/Odyssey/assets/js/64.f2cd0b44.js"><link rel="prefetch" href="/Odyssey/assets/js/65.47204a7c.js"><link rel="prefetch" href="/Odyssey/assets/js/66.605a4a82.js"><link rel="prefetch" href="/Odyssey/assets/js/67.34132ce0.js"><link rel="prefetch" href="/Odyssey/assets/js/68.f3bcfc00.js"><link rel="prefetch" href="/Odyssey/assets/js/69.3640c28b.js"><link rel="prefetch" href="/Odyssey/assets/js/7.869b5935.js"><link rel="prefetch" href="/Odyssey/assets/js/70.e2a8446b.js"><link rel="prefetch" href="/Odyssey/assets/js/71.c9f6b4d3.js"><link rel="prefetch" href="/Odyssey/assets/js/72.201bfcc2.js"><link rel="prefetch" href="/Odyssey/assets/js/73.7e8e995e.js"><link rel="prefetch" href="/Odyssey/assets/js/74.ea2a2167.js"><link rel="prefetch" href="/Odyssey/assets/js/75.7009c10e.js"><link rel="prefetch" href="/Odyssey/assets/js/76.48b75434.js"><link rel="prefetch" href="/Odyssey/assets/js/77.fa8e9cd3.js"><link rel="prefetch" href="/Odyssey/assets/js/78.5cb5a672.js"><link rel="prefetch" href="/Odyssey/assets/js/79.5adebe29.js"><link rel="prefetch" href="/Odyssey/assets/js/8.a0861537.js"><link rel="prefetch" href="/Odyssey/assets/js/80.fcb9624a.js"><link rel="prefetch" href="/Odyssey/assets/js/81.42c49b3a.js"><link rel="prefetch" href="/Odyssey/assets/js/82.477309e7.js"><link rel="prefetch" href="/Odyssey/assets/js/83.38767490.js"><link rel="prefetch" href="/Odyssey/assets/js/84.c80b8f93.js"><link rel="prefetch" href="/Odyssey/assets/js/85.b1ca1383.js"><link rel="prefetch" href="/Odyssey/assets/js/86.0bb83cf2.js"><link rel="prefetch" href="/Odyssey/assets/js/87.632e928e.js"><link rel="prefetch" href="/Odyssey/assets/js/88.924c9285.js"><link rel="prefetch" href="/Odyssey/assets/js/89.34d3c3ff.js"><link rel="prefetch" href="/Odyssey/assets/js/9.14a4b067.js"><link rel="prefetch" href="/Odyssey/assets/js/90.2e394c85.js"><link rel="prefetch" href="/Odyssey/assets/js/91.b604e092.js"><link rel="prefetch" href="/Odyssey/assets/js/92.94b169d8.js"><link rel="prefetch" href="/Odyssey/assets/js/93.0e2742ef.js"><link rel="prefetch" href="/Odyssey/assets/js/94.449bcab7.js"><link rel="prefetch" href="/Odyssey/assets/js/95.250c02be.js"><link rel="prefetch" href="/Odyssey/assets/js/96.eee6aed4.js"><link rel="prefetch" href="/Odyssey/assets/js/97.3198ad58.js"><link rel="prefetch" href="/Odyssey/assets/js/98.1b0a34c9.js"><link rel="prefetch" href="/Odyssey/assets/js/99.9021c172.js">
    <link rel="stylesheet" href="/Odyssey/assets/css/0.styles.35a5e89f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Odyssey/" class="home-link router-link-active"><!----> <span class="site-name">Hungry&amp;Eating</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Odyssey/reading/" class="nav-link">
  阅读
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机综合" class="dropdown-title"><span class="title">学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机综合" class="mobile-dropdown-title"><span class="title">学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Odyssey/cache/" class="nav-link">
  缓存
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/code/" class="nav-link">
  coding
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/struct/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/db/" class="nav-link router-link-active">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/storage/" class="nav-link">
  存储
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/protocol/" class="nav-link">
  协议
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/network/" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/design/" class="nav-link">
  设计
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/web/" class="nav-link">
  www
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/insight/" class="nav-link">
  理解
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/unclassified/" class="nav-link">
  未分类
</a></li></ul></div></div> <a href="https://github.com/firekillice/Odyssey" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Odyssey/reading/" class="nav-link">
  阅读
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机综合" class="dropdown-title"><span class="title">学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机综合" class="mobile-dropdown-title"><span class="title">学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Odyssey/cache/" class="nav-link">
  缓存
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/code/" class="nav-link">
  coding
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/struct/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/algorithm/" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/db/" class="nav-link router-link-active">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/storage/" class="nav-link">
  存储
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/protocol/" class="nav-link">
  协议
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/network/" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/design/" class="nav-link">
  设计
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/distribution/" class="nav-link">
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/web/" class="nav-link">
  www
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/insight/" class="nav-link">
  理解
</a></li><li class="dropdown-item"><!----> <a href="/Odyssey/unclassified/" class="nav-link">
  未分类
</a></li></ul></div></div> <a href="https://github.com/firekillice/Odyssey" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Odyssey/db/mongodb.html" class="sidebar-link">mongo</a></li><li><a href="/Odyssey/db/storageEngine.html" aria-current="page" class="active sidebar-link">存储引擎</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Odyssey/db/storageEngine.html#为什么需要存储引擎" class="sidebar-link">为什么需要存储引擎</a></li><li class="sidebar-sub-header"><a href="/Odyssey/db/storageEngine.html#wiredtiger" class="sidebar-link">WiredTiger</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Odyssey/db/storageEngine.html#checkpoint" class="sidebar-link">checkpoint</a></li><li class="sidebar-sub-header"><a href="/Odyssey/db/storageEngine.html#cache-page-extend" class="sidebar-link">cache &amp; page &amp; extend</a></li><li class="sidebar-sub-header"><a href="/Odyssey/db/storageEngine.html#block-manager" class="sidebar-link">block manager</a></li></ul></li><li class="sidebar-sub-header"><a href="/Odyssey/db/storageEngine.html#disk-space-relaim" class="sidebar-link">disk space relaim</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Odyssey/db/storageEngine.html#mvcc-多版本并发控制" class="sidebar-link">mvcc (多版本并发控制)</a></li><li class="sidebar-sub-header"><a href="/Odyssey/db/storageEngine.html#理解" class="sidebar-link">理解</a></li><li class="sidebar-sub-header"><a href="/Odyssey/db/storageEngine.html#暂时写在这里" class="sidebar-link">暂时写在这里</a></li></ul></li><li class="sidebar-sub-header"><a href="/Odyssey/db/storageEngine.html#mmapv1" class="sidebar-link">MMAPV1</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Odyssey/db/storageEngine.html#journaling" class="sidebar-link">journaling</a></li></ul></li><li class="sidebar-sub-header"><a href="/Odyssey/db/storageEngine.html#in-memory-mongodb企业版中可用" class="sidebar-link">In-Memory(Mongodb企业版中可用)</a></li><li class="sidebar-sub-header"><a href="/Odyssey/db/storageEngine.html#refence" class="sidebar-link">refence</a></li></ul></li><li><a href="/Odyssey/db/Theory.html" class="sidebar-link">范式(Normal Form)</a></li><li><a href="/Odyssey/db/IndexConstruction.html" class="sidebar-link">索引</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="存储引擎"><a href="#存储引擎" class="header-anchor">#</a> 存储引擎</h1> <h2 id="为什么需要存储引擎"><a href="#为什么需要存储引擎" class="header-anchor">#</a> 为什么需要存储引擎</h2> <ul><li>当只存储一个文件的时候，我们就使用Ctl+S就行了；可是当有几十上百个文件需要同时存储的时候，我们应该怎么办呢？ 就需要一个存储调度的软件，来提升并发和吞吐量</li> <li>比如对于MMAPv1而言，它就将所有文件直接映射到虚拟空间中，在这个虚拟空间中进行统一管理和调度</li> <li><img src="/Odyssey/assets/img/db-basic-layer.3a8a8f4b.png" alt="basic-layer"></li></ul> <h2 id="wiredtiger"><a href="#wiredtiger" class="header-anchor">#</a> WiredTiger</h2> <ul><li>每个collection在硬盘上对应一个物理文件和一个index文件；在内存中对应一个BTree和一个checkpoint</li> <li>当60s进行整体checkpoint的时候，每个collection都会生成checkpoint，然后汇集到WiredTiger.wt, WiredTiger.wt再进行checkpoint到WiredTiger.turtle</li> <li>修改被写入磁盘：reconciliation，时刻：cache full、on a checkpoint、after X operations</li> <li>释放内存: evction thread</li> <li>校验机制：checksum， 避免磁盘有坏点等问题</li> <li>压缩机制：snappy/zlib，在block management完成，利用目前比较快的CPU计算速度，来平衡硬盘的写入延迟</li> <li>所有的普通write请求是基于document锁，而事务的隔离级别是snapshot</li> <li>一对相反操作：page inmem 与 page on-disk</li> <li>底层使用kv存储，默认是行存储 row-store，支持列存储；行存储下，key和value都是可变字符串，长度4GB - 512B</li> <li>使用URI的方式统一定为管理的所有文件</li></ul> <h3 id="checkpoint"><a href="#checkpoint" class="header-anchor">#</a> checkpoint</h3> <ul><li>checkpoint的生成流程<br> <img src="/Odyssey/assets/img/wt-cache-checkpoint-circle.d63a8c7e.png" alt="checkpoint-process"></li> <li><strong>checkpoint是使用snapshot获得的</strong>，snapshot的内容写入到磁盘就是checkpoint了，而checkpoint本质上相当于一个日志, 记录了上次Checkpoint后相关数据文件的变化</li> <li>checkpoint是面向磁盘page的变化的，也就是它快照了上次的变化数据</li> <li>snapshot 和checkpoint都是Session提供的接口</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>// checkpoint
int WT_SESSION::checkpoint	(	WT_SESSION * 	session,
const char * 	config 
)	
Write a transactionally consistent snapshot of a database.
All data files in the database are updated with snapshots that reflect the transactions committed before the checkpoint starts.

// snapshot
int WT_SESSION::sync	(	WT_SESSION * 	session,
const char * 	name,
const char * 	config 
)	
Snapshot a table or file.
Flush dirty pages from a table or file to stable storage, creating a snapshot 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ul><li>session create，可以看出session是基于一个collection的</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>int WT_SESSION::create	(	WT_SESSION * 	session,
const char * 	name,
const char * 	config 
)
session	the session handle
name	the URI of the object to create, such as &quot;table:stock&quot;
config	Configuration string, see Configuration Strings. Permitted values:
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="cache-page-extend"><a href="#cache-page-extend" class="header-anchor">#</a> cache &amp; page &amp; extend</h3> <ul><li>硬盘上的B树(具体说应该是B+)映射到内存中的B树，内存中增加了对数据的操作；中间节点只存储keys，而叶子节点存储数据和keys <br><img src="/Odyssey/assets/img/wt-cache-b-tree.b9116f05.png" alt="wt-b-tree"></li> <li>内存和磁盘上的page数据格式, 在磁盘上的page被称为extent，它由page header、block header和kv列表三部分组成，其中page header存储了extent经过解压和解密后在内存中的大小。block header存储了extent在磁盘中的大小和checksum值。kv列表中的key和value都是由cell和data两部分组成，cell存储了data的数据格式和长度，data就是具体的k/v值。具体描述如下<br><img src="/Odyssey/assets/img/wt-cache-page.2d4371d6.png" alt="page-usage"><br></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>Page页内检索时，通过row_array/insert_array/update_array 数组一一对应的查找。即查找的时候，需要遍历三个数组中的所有信息
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>使用例子
假如一个 page 存储了一个 [0，100] 的 key 范围，磁盘上原来存储的行 key=2， 10 ，20， 30 ， 50， 80， 90，他们的值分别是value = 102， 110， 120， 130， 150， 180， 190。在 page 数据从磁盘读到内存后，分别对 key=2 的 value 进行了两次修改，两次修改的值是分别 402，502。对 key = 20 ，50 的 value 做了一次修改，修改后的 value = 122， 155，后有分配 insert 了新的 key = 3，5， 41， 99，value = 203，205，241，299。<br> <img src="/Odyssey/assets/img/wt-cache-page-process.51c2bf73.png" alt="use-example"></li> <li>cache的数据BTree的查找是以RecordId为key值的</li> <li>如果page的size增长到配置的最大值，则会被拆分</li> <li></li></ul> <h3 id="block-manager"><a href="#block-manager" class="header-anchor">#</a> block manager</h3> <ul><li>将page切分为更小的block进行存储</li> <li>压缩和解压</li></ul> <h2 id="disk-space-relaim"><a href="#disk-space-relaim" class="header-anchor">#</a> disk space relaim</h2> <ul><li>The WiredTiger storage engine maintains lists of empty records in data files as it deletes documents. This space can be reused by WiredTiger, but will not be returned to the operating system unless under very specific circumstances.</li></ul> <h3 id="mvcc-多版本并发控制"><a href="#mvcc-多版本并发控制" class="header-anchor">#</a> mvcc (多版本并发控制)</h3> <ul><li>事务的实现，注意：<strong>事务的snapshot和进行checkpoint的snapshot不同</strong>，一个是扫描所有的事务，一个扫描BTree的修改信息</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>transaction的ACID
        ├── MVCC 
        ├── 事务snapshot
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>不同的连接用户看到的是不同的数据</li> <li>基于snapshot实现了checkpoint、transaction</li> <li>MVCC利用的是对事务的状态跟踪和&quot;一往无前&quot;的特性</li> <li>就好像在一个混乱的菜市场中，商贩的售卖过程也是一个有时序的流(通过称来控制)</li></ul> <h3 id="理解"><a href="#理解" class="header-anchor">#</a> 理解</h3> <ul><li>可以将wiredTiger理解为一个高并发的KV系统，接口示例：</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>        //insert
        const char *key = &quot;some key&quot;, *value = &quot;some value&quot;;
        error_check(session-&gt;open_cursor(session, &quot;table:mytable&quot;, NULL, NULL, &amp;cursor));
        cursor-&gt;set_key(cursor, key);
        cursor-&gt;set_value(cursor, value);
        error_check(cursor-&gt;insert(cursor));

        //modify
        WT_MODIFY entries[3];
        const char *key = &quot;some key&quot;;
        /* Position the cursor. */
        cursor-&gt;set_key(cursor, key);
        error_check(cursor-&gt;search(cursor));
        /* Replace 20 bytes starting at byte offset 5. */
        entries[0].data.data = &quot;some data&quot;;
        entries[0].data.size = strlen(entries[0].data.data);
        entries[0].offset = 5;
        entries[0].size = 20;
        /* Insert data at byte offset 40. */
        entries[1].data.data = &quot;and more data&quot;;
        entries[1].data.size = strlen(entries[1].data.data);
        entries[1].offset = 40;
        entries[1].size = 0;
        /* Replace 2 bytes starting at byte offset 10. */
        entries[2].data.data = &quot;and more data&quot;;
        entries[2].data.size = strlen(entries[2].data.data);
        entries[2].offset = 10;
        entries[2].size = 2;
        error_check(cursor-&gt;modify(cursor, entries, 3));

        //delete
        const char *key = &quot;some key&quot;;
        error_check(session-&gt;open_cursor(session, &quot;table:mytable&quot;, NULL, NULL, &amp;cursor));
        cursor-&gt;set_key(cursor, key);
        error_check(cursor-&gt;remove(cursor));
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="暂时写在这里"><a href="#暂时写在这里" class="header-anchor">#</a> 暂时写在这里</h3> <ul><li>When an application does an insert or an update of a key/value pair, the associated key is used to refer to an in-memory page.</li> <li>extent的理解，有点像虚拟内存分配的意思，在两个很大的空间上尽量的挥洒汗水</li></ul> <h2 id="mmapv1"><a href="#mmapv1" class="header-anchor">#</a> MMAPV1</h2> <h3 id="journaling"><a href="#journaling" class="header-anchor">#</a> journaling</h3> <ul><li>journaling procedure<br> <img src="/Odyssey/assets/img/storage-journaling.78eb2a75.png" alt="journal-procedure"></li> <li>从journaling的设计可以看出，我们无法百分百保证数据不丢失，能做到是尽量降低数据的丢失粒度，使用日志，我们可以做到数据丢失间隔为从60s缩短到200ms，如果想更加缩短可以使用<strong>writeConcern</strong></li> <li>journal保存的是操作，用于replay，这个操作是底层对数据的某些区域的修改，比如修改file[0:offset], 而不是最上层的update、write函数</li> <li>shared view 和private view 以某种mapping相连接(写本文时还不知道使用什么技术)，效果是：相同的内容使用同样的物理内存，而不同内容才会申请新的内存页，这样避免了物理内存的浪费</li> <li>private view 向shared view的同步数据有两种方式, (1)直接内存拷贝 (2)record重放，写本文时候还没有弄清楚，个人倾向于重播，主要是mapping技术实现方式没弄清楚</li> <li>对private view的写操作生成了journal record</li></ul> <h2 id="in-memory-mongodb企业版中可用"><a href="#in-memory-mongodb企业版中可用" class="header-anchor">#</a> In-Memory(Mongodb企业版中可用)</h2> <h2 id="refence"><a href="#refence" class="header-anchor">#</a> refence</h2> <ul><li><a href="https://blog.csdn.net/daaikuaichuan/article/details/97893552" target="_blank" rel="noopener noreferrer">WiredTiger的事务实现详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/firekillice/Odyssey/edit/master/docs/db/storageEngine.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: :</span> <span class="time">1/7/2021, 3:44:36 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Odyssey/db/mongodb.html" class="prev">
        mongo
      </a></span> <span class="next"><a href="/Odyssey/db/Theory.html">
        范式(Normal Form)
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Odyssey/assets/js/app.736f8b8a.js" defer></script><script src="/Odyssey/assets/js/2.044c5f79.js" defer></script><script src="/Odyssey/assets/js/14.dd904d52.js" defer></script>
  </body>
</html>
